---
title: "Manuscript_1_Chemical_Analysis_directory_RBRA"
author: "Rita H. R. Branco"
date: "7/27/2021"
output: html_document
---

This is an R Markdown document contains an analysis of micropollutant removal and microbial activity of an experiment of Rita H.R. Branco.

## Install packages

```{r import data, message=F, echo=T, eval=T, warning=F, include=T, cache=F}
knitr::opts_chunk$set(echo = TRUE)

options(scipen = 999) # tell R to avoid all scientific notation

# Packages names
packages <- c("readxl", "dplyr", "ggplot2", "openxlsx", "reshape2", "ggh4x", "RColorBrewer", "rmarkdown", "tidyverse", "cowplot", "scales")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

library(readxl) #load packages
library(dplyr)
library(ggplot2)
library(openxlsx)
library(reshape2)
library(ggh4x)
library(RColorBrewer)
library(rmarkdown)
library(tidyverse)
library(cowplot)
library(scales)
```

# 1. Loading, exploring and treating the data

## 1.1. Removal efficiency

### 1.1.1. Define the class of each column
```{r class of each column, message=F, echo=T, eval=T, warning=F, include=T, cache=F}
heatmap_short <- read_excel("input_data/removal_efficiencies_manuscript_1.xlsx", col_types = c("text", "text", "text", "text",
                                                               "numeric", "numeric", "numeric",
                                                               "numeric", "numeric", "numeric",
                                                               "numeric", "numeric", "numeric",
                                                               "numeric", "numeric", "numeric",
                                                               "numeric", "numeric", "numeric", 
                                                               "numeric"))
#Note: There were 32 more warnings -> Expecting numeric got 'NA'
```

### 1.1.2. Creating a compound column and respective removal efficiency column
```{r compound removal efficiency, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
heatmap_long = melt(heatmap_short, id.vars = c("SampleID", "RedoxCondition","Inoculum", "Respike"), 
                 variable.name = "Compound", value.name = "Removal_Efficiency")
```

### 1.1.3. Reordering data (reordering facets of facet plot using relevel function)
```{r data reorder, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
heatmap_ordered <- heatmap_long
heatmap_ordered$RedoxCondition <- factor(heatmap_ordered$RedoxCondition, levels = c("Aerobic", "Nitrate_red", "Iron_red", "Sulfate_red", "Methanogenic"))
heatmap_ordered$Inoculum <- factor(heatmap_ordered$Inoculum, levels = c("Soil", "Mun_AS", "Ditch", "Ind_AS"))
heatmap_ordered$Respike <- factor(heatmap_ordered$Respike, levels = c("Before", "After"))
heatmap_ordered$Compound <- factor(heatmap_ordered$Compound, levels = c("24_D", "MCPP", "CLZ", "CLZ_DP", "CLZ_MDP", "DCB", "BAM", "MET", "MET_ESA", "MET_OA", "BTZ", "ANP", "CBZ", "GAB", "ACK", "1H_BTR"))
```

### 1.1.4. Reoordering y axis and creat new variables for removal efficiency
```{r y axis reorder, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
round0 <- function(x) ifelse(abs(x) < 1, format(round(x, 2), nsmall = 1), ifelse(abs(x) < 10, format(round(x, 1), nsmall = 1), round(x, 0)))

heatmap_final <- heatmap_ordered %>%
      mutate(Compound = factor(Compound,levels = rev(sort(unique(Compound))))) %>%
      mutate(RemovalEfficiency = cut(Removal_Efficiency,breaks=c(-91, -90, -60, -30, 30, 60, 90, max(Removal_Efficiency, na.rm=T)),
                             labels = c("<=-90", "<=-60", "<=-30", ">-30 & <30", ">=30", ">=60", ">=90"))) %>%
      mutate(RemovalEfficiency = factor(as.character(RemovalEfficiency), levels = rev(levels(RemovalEfficiency)))) %>%
      mutate(RemovalEf = round0(Removal_Efficiency))
```

### 1.1.5. Separating before and after re-spiking
```{r separate before and after, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
heatmap_before <- heatmap_final %>%
  filter(Respike == "Before") %>%
  select(!Respike)

heatmap_after <- heatmap_final %>%
  filter(Respike == "After") %>%
  select(!Respike)
```

## 1.2. Consumption/production data

### 1.2.1. Define the class of each column
```{r column class, message=F, echo=T, eval=T, warning=F, include=T, cache=F}
data_short <- read_excel("input_data/consumption_data_manuscript_1.xlsx", col_types = c("text", "text", "text", "text",
                                                               "numeric", "numeric", "numeric",
                                                               "numeric", "numeric", "numeric",
                                                               "numeric", "numeric", "numeric",
                                                               "numeric", "numeric", "numeric",
                                                               "numeric", "numeric", "numeric", 
                                                               "numeric", "numeric", "numeric",
                                                               "numeric", "numeric", "numeric",
                                                               "numeric", "numeric", "numeric", 
                                                               "numeric"))
#Note: There were 50 or more warnings -> Expecting numeric got 'NA'

#str(data_short)
#head(data_short)
#names(data_short)
#View(data_short)
#class(data_short)
#dim(data_short)
#data_short$SampleID
#summary(data_short)
```

### 1.2.2. Creating a compound column and respective concentration column
```{r concentration column, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
data_long_NA = melt(data_short, id.vars = c("SampleID", "RedoxCondition","Inoculum", "Respike", "Time"), 
                 variable.name = "Compound", value.name = "Concentration")
```

### 1.2.3. Removing NA data
```{r NA removal, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
data_long <- na.omit(data_long_NA)
```

### 1.2.4. Reordering data (reordering facets of facet plot using relevel function)
```{r reorder, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
data_ordered <- data_long
data_ordered$RedoxCondition <- factor(data_ordered$RedoxCondition, levels = c("Aerobic", "Nitrate_red", "Iron_red", "Sulfate_red", "Methanogenic"))
data_ordered$Inoculum <- factor(data_ordered$Inoculum, levels = c("Soil", "Mun_AS", "Ditch", "Ind_AS"))
data_ordered$Respike <- factor(data_ordered$Respike, levels = c("Before", "After"))
data_ordered$Compound <- factor(data_ordered$Compound, levels = c("24_D", "MCPP", "CLZ", "CLZ_DP", "CLZ_MDP", "DCB", "BAM", "MET", "MET_ESA", "MET_OA", "BTZ", "ANP", "CBZ", "GAB", "ACK", "1H_BTR", "Oxygen", "Nitrate", "Sulfate", "Carbon_Diox", "Ammonium", "Nitrite", "Methane"))
```

### 1.2.5. Keeping only micropollutants in compound column
```{r keep MP column, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
#micropollutants removed before re-spiking
data_micropol_b <- data_ordered %>% filter(!Compound == "DOC", 
                                         !Compound == "Sulfate",
                                         !Compound == "Nitrite",
                                         !Compound == "Nitrate",
                                         !Compound == "Ammonium",
                                         !Compound == "Methane",
                                         !Compound == "Carbon_Diox",
                                         !Compound == "Oxygen", 
                                         !Compound == "BAM", 
                                         !Compound == "DCB",
                                         !Respike == "After")

data_micropol_select_b <- data_micropol_b %>% filter (
  (Compound == "GAB" & RedoxCondition == "Aerobic" & (Inoculum == "Soil" | Inoculum == "Mun_AS" | Inoculum == "Ditch"))
  | (Compound == "ACK" & (RedoxCondition == "Aerobic"| RedoxCondition == "Nitrate_red") & (Inoculum == "Ind_AS" | Inoculum == "Mun_AS"))
  | (Compound == "CBZ" & Inoculum == "Soil" & !RedoxCondition == "Nitrate_red")
  | (Compound == "MCPP" & RedoxCondition == "Aerobic" & !Inoculum == "Ditch")
  | (Compound == "24_D" & ((RedoxCondition == "Aerobic") | ((Inoculum == "Ditch" | Inoculum == "Soil") & RedoxCondition == "Nitrate_red") | ((Inoculum == "Ditch" | Inoculum == "Soil") & RedoxCondition == "Iron_red") | ((Inoculum == "Soil" | Inoculum == "Mun_AS") & RedoxCondition == "Methanogenic")))
  | (Compound == "ANP" & ((RedoxCondition == "Aerobic") | (Inoculum == "Ditch" & RedoxCondition == "Nitrate_red")))
  | (Compound == "BTZ" & RedoxCondition == "Aerobic" & Inoculum == "Soil")
  | (Compound == "1H_BTR" & ((RedoxCondition == "Aerobic") | ((Inoculum == "Ditch" | Inoculum == "Soil") & RedoxCondition == "Nitrate_red") | ((Inoculum == "Ditch" | Inoculum == "Soil") & RedoxCondition == "Iron_red") | ((Inoculum == "Ditch" | Inoculum == "Soil") & RedoxCondition == "Sulfate_red") | (Inoculum == "Soil" & RedoxCondition == "Methanogenic")))
  | (Compound == "CLZ_DP" & ((RedoxCondition == "Aerobic" & (Inoculum == "Soil" | Inoculum == "Mun_AS")) | (Inoculum == "Soil" & RedoxCondition == "Iron_red")))
  | (Compound == "CLZ_MDP" & Inoculum == "Mun_AS" & RedoxCondition == "Aerobic")
  | (Compound == "CLZ" & ((RedoxCondition == "Aerobic" & (Inoculum == "Soil" | Inoculum == "Mun_AS")) | (Inoculum == "Soil" & RedoxCondition == "Iron_red") | (Inoculum == "Soil" & RedoxCondition == "Sulfate_red") | (Inoculum == "Soil" & RedoxCondition == "Methanogenic")))
  | (Compound == "MET_ESA" & (Inoculum == "Ditch" & RedoxCondition == "Sulfate_red"))
  | (Compound == "MET_OA" & ((Inoculum == "Soil" & RedoxCondition == "Iron_red") | (Inoculum == "Ditch" & RedoxCondition == "Sulfate_red")))
  | (Compound == "MET" & (((Inoculum == "Soil" | Inoculum == "Ind_AS") & RedoxCondition == "Aerobic") | ((Inoculum == "Ditch" | Inoculum == "Soil") & RedoxCondition == "Nitrate_red") | (RedoxCondition == "Iron_red") | (RedoxCondition == "Sulfate_red") | (RedoxCondition == "Methanogenic")))
)

#micropollutants removed both before and after re-spiking 
data_micropol_ba <- data_ordered %>% filter(!Compound == "DOC", 
                                         !Compound == "Sulfate",
                                         !Compound == "Nitrite",
                                         !Compound == "Nitrate",
                                         !Compound == "Ammonium",
                                         !Compound == "Methane",
                                         !Compound == "Carbon_Diox",
                                         !Compound == "Oxygen", 
                                         !Compound == "BAM", 
                                         !Compound == "DCB", 
                                         !Compound == "GAB", 
                                         !Compound == "BTZ", 
                                         !Compound == "MET_ESA",
                                         !Compound == "MET_OA",
                                         !RedoxCondition == "Methanogenic")

data_micropol_select_ba <- data_micropol_ba %>% filter (
  (Compound == "ACK" & RedoxCondition == "Nitrate_red" & (Inoculum == "Ind_AS" | Inoculum == "Mun_AS"))
  | (Compound == "MCPP" & RedoxCondition == "Aerobic" & Inoculum == "Soil")
  | (Compound == "24_D" & ((RedoxCondition == "Aerobic" & Inoculum == "Soil") | (RedoxCondition == "Nitrate_red" & Inoculum == "Ditch") | (RedoxCondition == "Iron_red" & Inoculum == "Ditch")))
  | (Compound == "ANP" & RedoxCondition == "Aerobic")
  | (Compound == "1H_BTR" & RedoxCondition == "Aerobic" & Inoculum == "Soil")
  | (Compound == "CLZ_DP" & Inoculum == "Mun_AS" & RedoxCondition == "Aerobic")
  | (Compound == "CLZ_MDP" & Inoculum == "Mun_AS" & RedoxCondition == "Aerobic")
  | (Compound == "CLZ" & ((RedoxCondition == "Aerobic" & (Inoculum == "Soil" | Inoculum == "Mun_AS"))))
  | (Compound == "MET" & ((Inoculum == "Soil" & RedoxCondition == "Aerobic") | (Inoculum == "Ditch" & RedoxCondition == "Nitrate_red") | (RedoxCondition == "Iron_red") | (RedoxCondition == "Sulfate_red")))
  )
```

### 1.2.6. Keeping micropollutants per redox condition
```{r MP per redox, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
#micropollutants removed before re-spiking 
data_micropol_aerobic <- data_micropol_select_b %>% filter (RedoxCondition == "Aerobic")
data_micropol_nitrate <- data_micropol_select_b %>% filter (RedoxCondition == "Nitrate_red")
data_micropol_iron <- data_micropol_select_b %>% filter (RedoxCondition == "Iron_red")
data_micropol_sulfate <- data_micropol_select_b %>% filter (RedoxCondition == "Sulfate_red")
data_micropol_methanogenic <- data_micropol_select_b %>% filter (RedoxCondition == "Methanogenic")

#micropollutants removed both before and after re-spiking 
data_micropol_aerobic_ba <- data_micropol_select_ba %>% filter (RedoxCondition == "Aerobic")
data_micropol_nitrate_ba <- data_micropol_select_ba %>% filter (RedoxCondition == "Nitrate_red")
data_micropol_iron_ba <- data_micropol_select_ba %>% filter (RedoxCondition == "Iron_red")
data_micropol_sulfate_ba <- data_micropol_select_ba %>% filter (RedoxCondition == "Sulfate_red")
data_micropol_methanogenic_ba <- data_micropol_select_ba %>% filter (RedoxCondition == "Methanogenic")
```

### 1.2.7. Keeping micropollutants per inoculum
```{r MP per inoculum, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
#micropollutants removed before re-spiking 
data_micropol_ditch <- data_micropol_select_b %>% filter (Inoculum == "Ditch")
data_micropol_soil <- data_micropol_select_b %>% filter (Inoculum == "Soil")
data_micropol_indAS <- data_micropol_select_b %>% filter (Inoculum == "Ind_AS")
data_micropol_munAS <- data_micropol_select_b %>% filter (Inoculum == "Mun_AS")

#micropollutants removed both before and after re-spiking 
data_micropol_ditch_ba <- data_micropol_select_ba %>% filter (Inoculum == "Ditch")
data_micropol_soil_ba <- data_micropol_select_ba %>% filter (Inoculum == "Soil")
data_micropol_indAS_ba <- data_micropol_select_ba %>% filter (Inoculum == "Ind_AS")
data_micropol_munAS_ba <- data_micropol_select_ba %>% filter (Inoculum == "Mun_AS")
```

### 1.2.8. Keeping only electron acceptor and products
```{r keep electron acceptor, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
data_electron <- data_ordered %>% filter(Compound == "Sulfate"
                                         | Compound == "Nitrite" 
                                         | Compound == "Nitrate" 
                                         | Compound == "Ammonium"
                                         | Compound == "Methane" 
                                         | Compound == "Carbon_Diox"
                                         | Compound == "Oxygen")

data_aerob <- data_electron %>% filter(RedoxCondition == "Aerobic" & (Compound == "Oxygen" | Compound == "Carbon_Diox" | Compound == "Ammonium" | Compound == "Nitrate"))
data_nitratered <- data_electron %>% filter(RedoxCondition == "Nitrate_red" & (Compound == "Carbon_Diox" | Compound == "Nitrate"))
data_sulfatered <- data_electron %>% filter(RedoxCondition == "Sulfate_red" & Compound == "Sulfate")
data_methanogen <- data_electron %>% filter(RedoxCondition == "Methanogenic" & Compound == "Methane")

data_aerob_oxygen <- data_ordered %>% filter (Compound == "Oxygen" & RedoxCondition == "Aerobic")
data_aerob_carbondiox <- data_ordered %>% filter (Compound == "Carbon_Diox" & RedoxCondition == "Aerobic")
data_aerob_ammonium <- data_ordered %>% filter (Compound == "Ammonium" & RedoxCondition == "Aerobic")
data_aerob_nitrate <- data_ordered %>% filter (Compound == "Nitrate" & RedoxCondition == "Aerobic")

data_nitrate_carbondiox <- data_ordered %>% filter (Compound == "Carbon_Diox" & RedoxCondition == "Nitrate_red")
data_nitrate_nitrate <- data_ordered %>% filter (Compound == "Nitrate" & RedoxCondition == "Nitrate_red")

data_sulfate_sulfate <- data_ordered %>% filter (Compound == "Sulfate" & RedoxCondition == "Sulfate_red")

data_methanogen_methane <- data_ordered %>% filter (Compound == "Methane" & RedoxCondition == "Methanogenic")
```

# 2. Results and Discussion

## 2.1. Overview

### 2.1.1. Before 2nd spike (i.e. re-spiking)
```{r before, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.width=8, fig.height=4}
ggplot(data = heatmap_before, aes(x = RedoxCondition, y = Compound, fill = RemovalEfficiency)) +
  geom_tile(colour = "white", size = 0.2) +
  facet_nested(~ Inoculum) +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  scale_fill_manual(values = c("#D6604D", "#F4A582", "#FDDBC7", "#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3"), limits = c("<=-90", "<=-60", "<=-30", ">-30 & <30", ">=30", ">=60", ">=90")) +
  geom_text(aes(label = RemovalEf), size = 2.5) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks.x = element_line(size = 0.35),
        axis.ticks.y = element_blank(),
        axis.text.x	= element_text(angle = 45, hjust = 1),
        axis.text.y	= element_text(vjust = 1, hjust = 1),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        legend.key.size = unit(10, "pt"),
        panel.spacing = unit(5, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        plot.margin = margin(t = 5.5,
                             r = 15,
                             b = 5.5,
                             l = 5.5))
```

**Figure 1**. Micropollutant removal efficiency for the different redox condition/community type combinations between the 1st and 2nd spike.<br>

### 2.1.2. After 2nd spike (i.e. re-spiking)
```{r after, message=F, echo=T, eval=T, warning=F, include=T, cache=F, fig.width=8, fig.height=4}
ggplot(data = heatmap_after, aes(x = RedoxCondition, y = Compound, fill = RemovalEfficiency)) +
  geom_tile(colour = "white", size = 0.2) +
  facet_nested(~ Inoculum) +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  scale_fill_manual(values = c("#D6604D", "#F4A582", "#FDDBC7", "#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3"), limits = c("<=-90", "<=-60", "<=-30", ">-30 & <30", ">=30", ">=60", ">=90")) +
  geom_text(aes(label = RemovalEf), size = 2.5) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks.x = element_line(size = 0.35),
        axis.ticks.y = element_blank(),
        axis.text.x	= element_text(angle = 45, hjust = 1),
        axis.text.y	= element_text(vjust = 1, hjust = 1),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(5, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        plot.margin = margin(t = 5.5,
                             r = 15,
                             b = 5.5,
                             l = 5.5))
```

**Figure 2**. Micropollutant removal efficiency for the different redox condition/community type combinations 75 days after the 2nd spike.<br>

## 2.2. Removal rates

### 2.2.1. Micropollutants removed before re-spiking
```{r MP before, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.width=6, fig.height=8}
breakscompounds_1 <- c("24_D", "MCPP", "CLZ", "CLZ_DP", "CLZ_MDP", "MET", "MET_ESA", "MET_OA", "BTZ", "ANP", "CBZ", "GAB", "ACK", "1H_BTR")
valuesfill_1 <- c("#B2182B", "#EF8A62", "#FDDBC7", "#D1E5F0", "#67A9CF", "#2166AC", "#B2182B", "#EF8A62", "#FDDBC7", "#D1E5F0", "#67A9CF", "#2166AC", "#B2182B", "#EF8A62")
valuesshape_1 <- c(21, 21, 21, 21, 21, 21, 22, 22, 22, 22, 22, 22, 23, 23)

ggplot(data = data_micropol_select_b, mapping = aes(x = Time, 
                                                    y = Concentration, 
                                                    colour = Compound, 
                                                    fill = Compound, 
                                                    shape = Compound, 
                                                    linetype = Compound)) +
  geom_line(colour = "black", 
            size = 0.4) +
  geom_point(colour = "black") +
  scale_shape_manual(breaks = breakscompounds_1,
                     values = valuesshape_1) +
  scale_fill_manual (breaks = breakscompounds_1, 
                     values = valuesfill_1) +
  scale_linetype_manual(breaks = breakscompounds_1, 
                        values = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1)) +
  facet_nested(RedoxCondition ~ Inoculum) +
  scale_x_continuous(breaks = seq(0, 150, 25)) +
  scale_y_continuous(limits = c(-0.1, 1.6), 
                     breaks = seq(0, 1.6, 0.2), 
                     expand = c(0,0)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.width = unit(12, "pt"),
        legend.key.height = unit(10, "pt"),
        legend.position ="bottom",
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(5, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        panel.grid.major = element_line(colour = "grey87",
                                        size = 0.15))
```

**Figure S2**. Degradation curves of micropollutants removed during the 1st spike for each redox conditions and microbial community combination.<br>

### 2.2.2. Micropollutants removed both before and after re-spiking
```{r MP before and after, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.width=6, fig.height=8}
breakscompounds_2 <- c("24_D", "MCPP", "CLZ", "CLZ_DP", "CLZ_MDP", "MET", "ANP", "CBZ", "ACK", "1H_BTR")
valuesfill_2 <- c("#B2182B", "#EF8A62", "#FDDBC7", "#D1E5F0", "#67A9CF", "#2166AC", "#D1E5F0", "#67A9CF", "#B2182B", "#EF8A62")
valuesshape_2 <- c(21, 21, 21, 21, 21, 21, 22, 22, 23, 23)

ggplot(data = data_micropol_select_ba, mapping = aes(x = Time, 
                                                     y = Concentration, 
                                                     colour = Compound, 
                                                     fill = Compound, 
                                                     shape = Compound, 
                                                     linetype = Compound)) + 
  geom_line(colour = "black", 
            size = 0.4) +
  geom_point(colour = "black") +
  scale_shape_manual(breaks = breakscompounds_2,
                     values = valuesshape_2) +
  scale_fill_manual (breaks = breakscompounds_2, 
                     values = valuesfill_2) +
  scale_linetype_manual(breaks = breakscompounds_2, 
                        values = c(1,1,1,1,1,1,1,1,1,1)) +
  facet_nested(RedoxCondition + Respike ~ Inoculum) +
  scale_x_continuous(breaks = seq(0, 150, 25)) +
  scale_y_continuous(limits = c(-0.1, 1.206), 
                     breaks = seq(0, 1.2, 0.2), 
                     expand = c(0,0)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.width = unit(12, "pt"),
        legend.key.height = unit(10, "pt"),
        legend.position ="bottom",
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(5, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        panel.grid.major = element_line(colour = "grey87",
                                        size = 0.15))
```

**Figure 3**. Degradation curves of micropollutants removed after both the 1st and the 2nd spike for each redox conditions and microbial community combination.<br>

### 2.2.3. Microbial activity

#### 2.2.3.1. Aerobic
```{r aerobic activity, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
breaksinoculum_1 <- c("Soil", "Mun_AS", "Ditch", "Ind_AS")
valuesfill_4 <- c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")

ao <- ggplot(data = data_aerob_oxygen, mapping = aes(x = Time,
                                                     y = Concentration,
                                                     colour = Inoculum,
                                                     fill = Inoculum,
                                                     shape = Inoculum,
                                                     linetype = Inoculum)) +
  facet_nested(~ Compound + Respike) +
  geom_line(colour = "black", 
            size = 0.4) +
  geom_point(colour = "black", 
             shape = 21) + 
  scale_fill_manual (breaks = breaksinoculum_1, 
                     values = valuesfill_4) +
  scale_linetype_manual(breaks = breaksinoculum_1, 
                        values = c(1,1,1,1)) +
  scale_x_continuous(limits = c(0, 100), 
                     breaks = seq(0, 75, 25), 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(-21.67, 0.5), 
                     breaks = seq(-20, 0, 2.5), 
                     expand = c(0,0), 
                     labels = label_number(accuracy = 0.1)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.width = unit(12, "pt"),
        legend.key.height = unit(10, "pt"),
        legend.position ="bottom",
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(0, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        panel.grid.major = element_line(colour = "grey87",
                                        size = 0.15))

ac <- ggplot(data = data_aerob_carbondiox, mapping = aes(x = Time,
                                                         y = Concentration,
                                                         colour = Inoculum,
                                                         fill = Inoculum,
                                                         shape = Inoculum,
                                                         linetype = Inoculum)) +
  facet_nested(~ Compound + Respike) +
  geom_line(colour = "black", 
            size = 0.4) +
  geom_point(colour = "black", 
             shape = 21) + 
  scale_fill_manual (breaks = breaksinoculum_1, 
                     values = valuesfill_4) +
  scale_linetype_manual(breaks = breaksinoculum_1, 
                        values = c(1,1,1,1)) +
  scale_x_continuous(limits = c(0, 100), 
                     breaks = seq(0, 75, 25), 
                     expand = c(0,0)) +
scale_y_continuous(limits = c(-0.5, 6.15), 
                   breaks = seq(0, 6, 0.75), 
                   expand = c(0,0), 
                   labels = label_number(accuracy = 0.01)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.width = unit(12, "pt"),
        legend.key.height = unit(10, "pt"),
        legend.position ="bottom",
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(0, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        panel.grid.major = element_line(colour = "grey87",
                                        size = 0.15))

aa <- ggplot(data = data_aerob_ammonium, mapping = aes(x = Time,
                                                       y = Concentration,
                                                       colour = Inoculum,
                                                       fill = Inoculum,
                                                       shape = Inoculum,
                                                       linetype = Inoculum)) + 
  facet_nested(~ Compound + Respike) +
  geom_line(colour = "black", 
            size = 0.4) +
  geom_point(colour = "black", 
             shape = 21) + 
  scale_fill_manual (breaks = breaksinoculum_1, 
                     values = valuesfill_4) +
  scale_linetype_manual(breaks = breaksinoculum_1, 
                        values = c(1,1,1,1)) +
  scale_x_continuous(limits = c(0, 100), 
                     breaks = seq(0, 75, 25), 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(-6.5, 0.3), 
                     breaks = seq(-6, 0, 0.75), 
                     expand = c(0,0), 
                     labels = label_number(accuracy = 0.01)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.width = unit(12, "pt"),
        legend.key.height = unit(10, "pt"),
        legend.position ="bottom",
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(0, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        panel.grid.major = element_line(colour = "grey87",
                                        size = 0.15))

an <- ggplot(data = data_aerob_nitrate, mapping = aes(x = Time, 
                                                      y = Concentration, 
                                                      colour = Inoculum, 
                                                      fill = Inoculum, 
                                                      shape = Inoculum, 
                                                      linetype = Inoculum)) + 
  facet_nested(~ Compound + Respike) +
  geom_line(colour = "black", 
            size = 0.4) +
  geom_point(colour = "black", 
             shape = 21) + 
  scale_fill_manual (breaks = breaksinoculum_1, 
                     values = valuesfill_4) +
  scale_linetype_manual(breaks = breaksinoculum_1, 
                        values = c(1,1,1,1)) +
  scale_x_continuous(limits = c(0, 100), 
                     breaks = seq(0, 75, 25), 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(-0.67, 8.2), 
                     breaks = seq(0, 8, 1), 
                     expand = c(0,0), 
                     labels = label_number(accuracy = 0.01)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.width = unit(12, "pt"),
        legend.key.height = unit(10, "pt"),
        legend.position ="bottom",
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(0, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        panel.grid.major = element_line(colour = "grey87",
                                        size = 0.15))
```

#### 2.2.3.2. Nitrate reducing
```{r nitrate red activity, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
nn <- ggplot(data = data_nitrate_nitrate, mapping = aes(x = Time, 
                                                        y = Concentration, 
                                                        colour = Inoculum, 
                                                        fill = Inoculum, 
                                                        shape = Inoculum, 
                                                        linetype = Inoculum)) + 
  facet_nested(~ Compound + Respike) +
  geom_line(colour = "black", 
            size = 0.4) +
  geom_point(colour = "black", 
             shape = 21) + 
  scale_fill_manual (breaks = breaksinoculum_1, 
                     values = valuesfill_4) +
  scale_linetype_manual(breaks = breaksinoculum_1, 
                        values = c(1,1,1,1)) +
  scale_x_continuous(limits = c(0, 151), 
                     breaks = seq(0, 130, 30), 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(-13, 0.3), 
                     breaks = seq(-12, 0, 1.5), 
                     expand = c(0,0), 
                     labels = label_number(accuracy = 0.1)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.width = unit(12, "pt"),
        legend.key.height = unit(10, "pt"),
        legend.position ="bottom",
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(0, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        panel.grid.major = element_line(colour = "grey87",
                                        size = 0.15))

nc <- ggplot(data = data_nitrate_carbondiox, mapping = aes(x = Time, 
                                                           y = Concentration, 
                                                           colour = Inoculum, 
                                                           fill = Inoculum, 
                                                           shape = Inoculum, 
                                                           linetype = Inoculum)) + 
  facet_nested(~ Compound + Respike) +
  geom_line(colour = "black", 
            size = 0.4) +
  geom_point(colour = "black", 
             shape = 21) + 
  scale_fill_manual (breaks = breaksinoculum_1, 
                     values = valuesfill_4) +
  scale_linetype_manual(breaks = breaksinoculum_1, 
                        values = c(1,1,1,1)) +
  scale_x_continuous(limits = c(0, 151), 
                     breaks = seq(0, 130, 30), 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(-0.5, 6.15), 
                     breaks = seq(0, 6, 0.75), 
                     expand = c(0,0), 
                     labels = label_number(accuracy = 0.01)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.width = unit(12, "pt"),
        legend.key.height = unit(10, "pt"),
        legend.position ="bottom",
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(0, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        panel.grid.major = element_line(colour = "grey87",
                                        size = 0.15))
```

#### 2.2.3.3. Sulfate reducing
```{r sulfate red activity, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
s <- ggplot(data = data_sulfate_sulfate, mapping = aes(x = Time, 
                                                       y = Concentration, 
                                                       colour = Inoculum, 
                                                       fill = Inoculum, 
                                                       shape = Inoculum, 
                                                       linetype = Inoculum)) + 
  facet_nested(~ Compound + Respike) +
  geom_line(colour = "black", 
            size = 0.4) +
  geom_point(colour = "black", 
             shape = 21) + 
  scale_fill_manual (breaks = breaksinoculum_1, 
                     values = valuesfill_4) +
  scale_linetype_manual(breaks = breaksinoculum_1, 
                        values = c(1,1,1,1)) +
  scale_x_continuous(limits = c(0, 110), 
                     breaks = seq(0, 110, 30), 
                     expand = c(0,0)) +
  scale_y_continuous(limits = c(-3.25, 0.075), 
                     breaks = seq(-3, 0, 0.375), 
                     expand = c(0,0), 
                     labels = label_number(accuracy = 0.01)) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.width = unit(12, "pt"),
        legend.key.height = unit(10, "pt"),
        legend.position ="right",
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(0, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        panel.grid.major = element_line(colour = "grey87",
                                        size = 0.15))
```

#### 2.2.3.5. Global graph
```{r overall activity, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.width=8, fig.height=4}
legend <- get_legend(s)

row_1 <- plot_grid(ao + theme(legend.position="none"),
                   ac + theme(legend.position="none", axis.title.y = element_blank()),
                   aa + theme(legend.position="none", axis.title.y = element_blank()),
                   an + theme(legend.position="none", axis.title.y = element_blank()),
                   nrow = 1,
                   ncol = 4,
                   align = "v",
                   axis = "l",
                   labels = c("A", "", "", "")) 

row_2 <- plot_grid(nn + theme(legend.position="none"),
                   nc + theme(legend.position="none", axis.title.y = element_blank()),
                   s + theme(legend.position="none"),
                   legend,
                   nrow = 1,
                   ncol = 4,
                   align = "v",
                   axis = "l",
                   labels = c("B", "", "C", ""))

plot_grid (row_1, row_2, nrow = 2)
```

**Figure S3**. Cumulative consumption and production of different compounds per community type A) Consumption of oxygen and ammonium and production of carbon dioxide and nitrate under aerobic conditions; B) Consumption of nitrate and production of carbon dioxide under nitrate reducing conditions; C) Consumption of sulfate under sulfate reducing conditions.<br>