---
title: "RBRA_data_analysis_proj2_Q13921"
author: "Pieter van Veelen"
date: "7/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(scipen = 999) # tell R to avoid all scientific notation

setwd("C:/Users/Rita/Documents/R/Article1/scripts")

# Packages names
packages <- c("phyloseq", "qiime2R", "tidyverse", "magrittr", "devtools", "qiime2R", "here", "breakaway", "DivNet", "openxlsx", "ape", "vegan", "ggtext", "cowplot", "RColorBrewer", "microbiome", "lme4", "lmerTest","decontam", "remotes", "ampvis2", "speedyseq", "ggh4x", "kableExtra", "phia", "MASS", "ggord", "ggtext", "glue", "lubridate")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages not available in this version of R - 4.1.2
## phyloseq
#if(!requireNamespace("BiocManager")){install.packages("BiocManager")}
#BiocManager::install("phyloseq")

## qiime2R
#if (!requireNamespace("devtools", quietly = TRUE)){install.packages("devtools")}
#devtools::install_github("jbisanz/qiime2R")

## breakaway
#install.packages("devtools")
#devtools::install_github("adw96/breakaway")

## DivNet
#remotes::install_github("adw96/breakaway")
#remotes::install_github("adw96/DivNet")

## microbiome
#library(BiocManager)
#BiocManager::install("microbiome")

## decontam
#if (!requireNamespace("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")
#BiocManager::install("decontam")

## ampvis2
#if (!requireNamespace("ampvis2", quietly = TRUE))
    #install.packages("ampvis2")
#remotes::install_github("MadsAlbertsen/ampvis2", Ncpus = 6)
#https://sites.google.com/a/ciad.mx/bioinformatica/home/metagenomica/visualizacion/ampvis2 and https://madsalbertsen.github.io/ampvis2/articles/ampvis2.html

## speedyseq
#if (!requireNamespace("speedyseq", quietly = TRUE))
    #install.packages("speedyseq")
#remotes::install_github("mikemc/speedyseq")

## ggord
#if (!requireNamespace("ggord", quietly = TRUE))
#install.packages("remotes")
#remotes::install_github("fawda123/ggord")
```

## Exploratory data analysis

This is an R Markdown document contains an analysis of microbial community dynamics of an experiment of Rita Branco and Koen Deurloo in collaboration with Pieter van Veelen. 

### Loading libraries

```{r library loading, message=F, echo=T, eval=T, warning=T, include=F, cache=F}
## load required packages
library(phyloseq)
library(qiime2R)
library(tidyverse)
library(magrittr)
library(devtools)
library(qiime2R)
library(here)
library(breakaway)
library(DivNet)
library(openxlsx)
library(ape)
library(vegan)
library(ggtext)
library(cowplot)
library(RColorBrewer)
library(microbiome)
library(lme4)
library(lmerTest)
library(decontam)
library(remotes)
library(ampvis2)
library(speedyseq)
library(ggh4x)
```


### Data import

Below, the input data are imported in R. These files are output files from our QIIME2 (v.2019.10) sequence data pre-processing workflow. Scripts and parameter settings are found in separate bash files.

```{r import data, message=F, echo=T, eval=T, warning=T, include=F, cache=F}
#creating phyloseq objects with 
physeq = qza_to_phyloseq(features = "C:/Users/Rita/Documents/R/Article1/input_data/RBRA_proj2_Q13921_16S_515F926R_20210701_table.qza",
                        tree = "C:/Users/Rita/Documents/R/Article1/input_data/RBRA_proj2_Q13921_16S_515F926R_20210701_rooted-tree.qza",
                        taxonomy = "C:/Users/Rita/Documents/R/Article1/input_data/RBRA_proj2_Q13921_16S_515F926R_20210701_taxonomy_NB_classifier_SILVA_132_99_16S_515F-926R_QIIME2-2019.10.qza",
                        metadata = "C:/Users/Rita/Documents/R/Article1/input_data/RBRA_proj2_Q13921_16S_515F926R_20210701@metadata_formatted_v2.txt")

colnames(sample_data(physeq))
physeq

```

### Cleaning data set

The following steps are subsequently performed to clean the data: 1) bifurcating tree using ape package; 2) cleaning up the metadata; 3) replacing taxonomic strings that are empty, NA, metagenome, ambiguous taxa; 4) decontaminating based on frequency and prevalence using the DECONTAM package; 5) split blanks from samples; 

#### 1) Resolve phylogenetic tree

Number of tips = number internal nodes + 1. If this does not happens, then nodes from the phylogenetic tree have to be splited/bifurcated.

```{r clean phylogeny, message=F, echo=F, eval=T, warning=T, include=F, cache=F}
# evaluate tree topology
is.binary(phy_tree(physeq)) # if FALSE --> polychotomy present (node has more than 2 tips)

# if FALSE:
# resolve polychotomous nodes
phy_tree_resolved <- multi2di(phy_tree(physeq))
is.binary(phy_tree_resolved)

# create new phy_tree
tree2 <- phy_tree_resolved

# subset_taxa(phy_tree_resolved, Kingdom ==  "Bacteria")

# merge new phy_tree object with sample_data and otu_table into new phyloseq object
psdata_RBRA <- merge_phyloseq(otu_table(physeq), sample_data(physeq), tax_table(physeq), tree2)
psdata_RBRA

class(sample_data(psdata_RBRA)$Sample_type)
```

#### 2) Clean-up metadata

```{r}
sample_data(psdata_RBRA)$Redox_type <- factor(sample_data(psdata_RBRA)$Redox_type,
                                              levels=c("inoculum", "aerobic", "nitrate", "iron", "sulphate", "methanogenic"))

sample_data(psdata_RBRA)$Sample_type <- factor(sample_data(psdata_RBRA)$Sample_type, levels=c("soil", "mun", "ditch", "ind", "blank"))

names(sample_data(psdata_RBRA)) <- tolower(names(sample_data(psdata_RBRA))) # to avoid mistakes typing in both upper and lower case

```

#### 3) Clean-up taxa data

```{r clean taxanomy, message=F, echo=F, eval=T, warning=T, include=F, cache=F}
## remove Archaea, Chloroplast and Mitochondia and unassigned Kingdom

#View(tax_table(psdata_RBRA)) # 11217 ASVs in total
#physeq1 <- subset_taxa(psdata_RBRA, Kingdom == "D_0__Bacteria") # retain Archaea
#physeq2 <- subset_taxa(psdata_RBRA, Phylum == "Chloroplast") # none found
#physeq3 <- subset_taxa(psdata_RBRA, Class == "Chloroplast") # none found
physeq1 <- subset_taxa(psdata_RBRA, Order != "Chloroplast") # dropped 635 ASVs
physeq2 <- subset_taxa(physeq1, Family != "Mitochondria") # dropped 325 ASVs

## clean taxonomy tags with no information
# specify NA taxon name tags to last known taxon names
tax.clean <- data.frame(tax_table(physeq2))
#tax.clean <- data.frame(tax.clean)
mode(tax.clean)
str(tax.clean)

# change tags into characters - required for further code
tax.clean2 <- tax.clean
tax.clean2$Kingdom <- as.character(tax.clean2$Kingdom)
tax.clean2$Phylum <- as.character(tax.clean2$Phylum)
tax.clean2$Class <- as.character(tax.clean2$Class)
tax.clean2$Order <- as.character(tax.clean2$Order)
tax.clean2$Family <- as.character(tax.clean2$Family)
tax.clean2$Genus <- as.character(tax.clean2$Genus)
tax.clean2$Species <- as.character(tax.clean2$Species)
str(tax.clean2)

# remove ambiguous taxa
tax.clean = tax.clean2 %>% mutate_all(funs(str_replace(., "Ambiguous_taxa", "")))
tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "metagenome", "")))
#tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "uncultured archaeon", "")))
#tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "uncultured bacterium", "")))
tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "uncultured", "")))
#tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "unknown", "")))
tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "unidentified", "")))
tax.clean[is.na(tax.clean)] <- ""

# function replace name tags from [https://github.com/joey711/phyloseq/issues/850]
for (i in 1:nrow(tax.clean)){
  if (tax.clean[i,2] == ""){
    Kingdom <- paste("Kingdom_", tax.clean[i,1], sep = "")
    tax.clean[i, 2:7] <- Kingdom
  } else if (tax.clean[i,3] == ""){
    Phylum <- paste("Phylum_", tax.clean[i,2], sep = "")
    tax.clean[i, 3:7] <- Phylum
  } else if (tax.clean[i,4] == ""){
    Class <- paste("Class_", tax.clean[i,3], sep = "")
    tax.clean[i, 4:7] <- Class
  } else if (tax.clean[i,5] == ""){
    Order <- paste("Order_", tax.clean[i,4], sep = "")
    tax.clean[i, 5:7] <- Order
  } else if (tax.clean[i,6] == ""){
    Family <- paste("Family_", tax.clean[i,5], sep = "")
    tax.clean[i, 6:7] <- Family
  } else if (tax.clean[i,7] == ""){
    tax.clean$Species[i] <- paste("Genus_",tax.clean$Genus[i], sep = "_")
  }
}

psdata_newTaxtab <- psdata_RBRA
tax_table(psdata_newTaxtab) <- as.matrix(tax.clean)
tax_table(psdata_newTaxtab) #save previous tax_table not to overwrite

# put cleaned tax_table into phyloseq object
tax_table(physeq2) <- as.matrix(tax.clean)

psdata_RBRA <- physeq2 # overwrite psdata_RBRA for cleaned data

```

#### 4) Remove contaminants with DECONTAM

```{r decontam, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

# add sample_or_control column
sample_data(psdata_RBRA)$is.neg <- sample_data(psdata_RBRA)$sample_type == "blank"
sample_data(psdata_RBRA)$sample_or_control <- factor(if_else(sample_data(psdata_RBRA)$sample_type == "blank", "control", "sample"))

# replace DNA concentration = 0 for a very low DNA amount (necessary for further steps, otherwise samples is taken out of analysis)
sample_data(psdata_RBRA)$dna_ng_ml <- if_else(sample_data(psdata_RBRA)$dna_ng_ml == 0, 
                                              sample_data(psdata_RBRA)$dna_ng_ml+0.0001, 
                                              sample_data(psdata_RBRA)$dna_ng_ml)
  
df <- as.data.frame(sample_data(psdata_RBRA)) # put sample_data into a ggplot-friendly data.frame
df$librarysize <- sample_sums(psdata_RBRA) # 'samples_sums' returns the total number of individuals observed from each sample
df <- df[order(df$librarysize),] # 'order' returns a permutation which rearranges its first argument into ascending or descending order
df$index <- seq(nrow(df)) # 'seq' generates regular sequences, 'nrow' return the number of rows or columns present in an array-like object

df %>%    
ggplot(aes(x=index, y=librarysize, color=sample_or_control)) + 
  geom_point() + 
  scale_y_continuous(trans = "log10") +
  labs(y = "Library size (log10)", x = "Sample rank") +
  theme_classic()

# Useful info 'decontam'[http://bioconductor.riken.jp/packages/3.7/bioc/vignettes/decontam/inst/doc/decontam_intro.html] and [https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-018-0605-2]

# contaminants based on frequency (probability as function of DNA concentration)
contamdf.freq <- isContaminant(psdata_RBRA, method="frequency", conc="dna_ng_ml")
contamdf.freq %>% arrange(p.freq, desc = F) %>% head()

table(contamdf.freq$contaminant) # 158 contaminants based on frequency, 'table' uses the cross-classifying factors to build a contingency table of the counts at each combination of factor levels
head(which(contamdf.freq$contaminant)) #  179 258 349 354 355 431, 'which' gives the TRUE indices of a logical object

plot_frequency(psdata_RBRA, taxa_names(psdata_RBRA)[c(1,431)], conc="dna_ng_ml") + 
  xlab("DNA Concentration (ng/ml)\n(Quant-IT dsDNA kit)")

plot_frequency(psdata_RBRA, taxa_names(psdata_RBRA)[sample(which(contamdf.freq$contaminant),3)], conc="dna_ng_ml") +
  xlab("DNA Concentration (ng/ml)\n(Quant-IT dsDNA kit)")

# contaminants based on prevalence
contamdf.prev <- isContaminant(psdata_RBRA, method="prevalence", neg="is.neg", threshold=0.1)
table(contamdf.prev$contaminant) # 2 contaminants based on prevalence
head(which(contamdf.prev$contaminant)) # 2657 6535

# Make phyloseq object of presence-absence in negative controls and true samples
ps.pa <- transform_sample_counts(psdata_RBRA, function(abund) 1*(abund>0)) # 'transform_sample_counts' transforms the sample counts of a taxa abundance matrix according to a user-provided function
ps.pa.neg <- prune_samples(sample_data(ps.pa)$sample_or_control == "control", ps.pa) # 'prune_samples' defines a subset of samples to keep in a phyloseq object
ps.pa.pos <- prune_samples(sample_data(ps.pa)$sample_or_control == "sample", ps.pa)

# Make dataframe of prevalence in positive and negative samples
df.pa <- data.frame(pa.pos=taxa_sums(ps.pa.pos), pa.neg=taxa_sums(ps.pa.neg),
                      contaminant=contamdf.prev$contaminant) # 'taxa_sums' returns the total number of individuals observed from each species/taxa/OTU
ggplot(data=df.pa, aes(x=pa.neg, y=pa.pos, color=contaminant)) + geom_point() +
  xlab("Prevalence (Negative Controls)") + ylab("Prevalence (True Samples)")

# contaminants based on prevalence and frequency
contamdf.comb <- isContaminant(psdata_RBRA, method="combined", neg="is.neg", conc = "dna_ng_ml")
table(contamdf.comb$contaminant) # 44 contaminants based on prevalence and frequency combined
contamdf.comb %>% arrange(p, desc = F) %>% filter(p < 0.1)

# saving contaminant and decontaminated data
#selected method: prevalence (low biomass samples)
psdata_contam <-  prune_taxa(contamdf.prev$contaminant, psdata_RBRA) # save contaminant psdata
psdata_decontam <- prune_taxa(!contamdf.prev$contaminant, psdata_RBRA) # save decontaminated psdata

```

#### Remove blanks from the dataset

```{r select RBRA samples, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

## full dataset = psdata_decontam

# add SampleID
sample_data(psdata_decontam)$sampleid <- sample_names(psdata_decontam) # 'sample_names' gets sample names

# blanks, keep the taxa that are present on one or more of the blanks
psdata_RBRA_blank <- 
  prune_taxa(
    taxa_sums(
      subset_samples(psdata_decontam, sample_type == "blank")) > 0, 
      subset_samples(psdata_decontam, sample_type == "blank")) # 'subset_samples' subsets samples by sample_data expression

# samples, keep the taxa that are present on one ore more of the samples
psdata_RBRA_only <- 
  prune_taxa(
    taxa_sums(
      subset_samples(psdata_decontam, sample_type != "blank")) > 0, 
      subset_samples(psdata_decontam, sample_type != "blank"))

psdata_RBRA <- prune_taxa(taxa_sums(psdata_RBRA_only) >0, psdata_RBRA_only) # overwrite psdata_RBRA for data without blanks

```

### Rarefaction curves

#### calculate rarefaction curve 
```{r filter on abundance, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

# relative abundance data
psdata_RBRA_rel <- transform_sample_counts(psdata_RBRA, fun = function(x) x/sum(x)) # 10177 taxa (100% abundance)

# total reads left = 3645984
sum(sample_sums(psdata_RBRA))

# abundance filter at (0.01%, 0.1%, 0.5%), keep above 99% abundance when removing rare data
psdata_RBRA_0.01pct <- prune_taxa(taxa_sums(psdata_RBRA_rel) > 0.0001, psdata_RBRA) # 7590 taxa (99.46% abundance)
psdata_RBRA_0.1pct <- prune_taxa(taxa_sums(psdata_RBRA_rel) > 0.001, psdata_RBRA) # 2664 taxa (94.04% abundance) 

# associated relative abundances with filters
100*(sum(sample_sums(psdata_RBRA_0.01pct))/sum(sample_sums(psdata_RBRA)))
100*(sum(sample_sums(psdata_RBRA_0.1pct)/sum(sample_sums(psdata_RBRA))))

# choice: to continue downstream analysis with abundance filter that retains ASVs with at least 0.1% of total read abundance
psdata_RBRA_unfiltered <- psdata_RBRA # save unfiltered data
psdata_RBRA <- psdata_RBRA_0.01pct # overwrite psdata_RBRA for abundance filtered data

summary(sample_sums(psdata_RBRA_0.01pct))
sum(sample_sums(psdata_RBRA_0.01pct))
```

```{r reshape metadata, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

# reformat metadata
metadata = 
  data.frame(sample_data(psdata_RBRA), stringsAsFactors = T) %>% as_tibble() %>% 
  rename_all(. %>% tolower) %>% 
  mutate(combined = factor(paste0(redox_type,"-",sample_type,"-",time))) # will create new combined column with redox_type-sample_type-time information together

meta_formatted = sample_data(metadata)
sample_names(meta_formatted) = metadata$description
sample_data(psdata_RBRA) = meta_formatted

```
### General description
```{r general description, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

psdata_RBRA_phylum <- psdata_RBRA %>%  tax_glom(., "Phylum") %>% psmelt() %>% filter(redox_type == "inoculum", Abundance != 0)
psdata_RBRA_phylum %>% select(sample_type, Phylum) %>%  group_by(sample_type) %>% summarise(count = n_distinct(Phylum))

```

### Plotting rarefaction curves

These curves show how well the sequencing effort captured the diversity in the samples.
```{r rarefaction curves, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

## using amp_rarecurve function (does not yield a ggplot object)

# alpha rarefaction curve (https://github.com/MadsAlbertsen/ampvis2/blob/master/R/amp_rarecurve.R)
# source("C:/Users/Rita/Documents/R/Article1/scripts/amp_rarecurve.r")
# amp_rarecurve(psdata_RBRA, color = "sample_type", legend.position = "topleft", xlim = c(0, 50000))
# amp_rarecurve(psdata_RBRA_unfiltered, color = "sample_type", legend.position = "topleft", xlim = c(0, 50000))

#sample_data(psdata_RBRA)$sample <- sample_names(psdata_RBRA)
#df <- as.data.frame(sample_data(psdata_RBRA))
#df <- as_tibble(df)
# df %>% select(sample, everything())
# sample_data(psdata_RBRA) <- sample_data(df)


## using ampvis2 package (yields a ggplot object)

otus_tax = cbind(
  as.data.frame(psdata_RBRA@otu_table),
  as.data.frame(as.matrix(psdata_RBRA@tax_table))) # creates data frame from the otu and taxonomy table phuloseq objects, in which the rows are OTU IDs, the columns are samples, and the last 7 columns are the corresponding taxonomy assigned to the OTUs, named "Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species"

met = data.frame(psdata_RBRA@sam_data) # creates data frame from the sample data phyloseq object
met = select(met, sampleid, everything()) # moves sampleid column to the first column

data <- amp_load(otutable = otus_tax,
                 metadata = met)
# Species = ASVs, ideally by the minimum coverage depth full diversity should have been captured captured (all curves reached a plateau)

# minimum coverage of reads per sample
min(sample_sums(psdata_RBRA)) #16905

breaksinoculum <- c("soil", "mun", "ditch", "ind")
valuesfill <- c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")

amp_rarecurve(data = data, 
              color = "sample_type") +
  scale_color_manual (breaks = breaksinoculum,
                      values = valuesfill) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5)) +
  coord_cartesian(xlim = c(0,50000)) +
  geom_vline(xintercept = 16905, size = 0.25)

pdf("C:/Users/Rita/Documents/R/Article1/figures/Figure1_S3.pdf", width = 5, height = 3, useDingbats = F)

amp_rarecurve(data = data, 
              color = "sample_type") +
  scale_color_manual (breaks = breaksinoculum,
                      values = valuesfill) +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5)) +
  coord_cartesian(xlim = c(0,50000)) +
  geom_vline(xintercept = 16905, size = 0.25)
```
**Fig x**. Rarefaction curves. Species denotes number of amplicon sequence variants (ASVs) observed from the unrarefied data. Minimum coverage was 16886 reads per sample; a depth at which almost full diversity is captured. Hence, no samples were dropped in later stages.<br>

### Alpha diversity

```{r alpha diversity , message=F, echo=T, eval=T, warning=T, include=T, cache=T}
# Useful info on alpha and beta diversity https://forum.qiime2.org/t/alpha-and-beta-diversity-explanations-and-commands/2282

## all data (0.01% filtered)
psdata_RBRA

## rarefied to 16905 r/s
summary(sample_sums(psdata_RBRA))

set.seed(711)

ps_16905 <- rarefy_even_depth(psdata_RBRA, 16905, rngseed = 711) # lost 0 samples to 100 left

#ps_30000 <- rarefy_even_depth(psdata_RBRA, 30000, rngseed = 711) # lost 6 samples to 30 left

#ps_16886_genus <- tax_glom(ps_16886, "Genus") # 'tax_glom' merges species that have the same taxonomy at a certain taxonomic rank

# calculate richness
metadata <- data.frame(sample_data(ps_16905))
alpha <- estimate_richness(ps_16905, measures = c("Chao1", "Shannon"))
#alpha_genus <- estimate_richness(ps_16886_genus, measures = c("Chao1", "Shannon"))

alpha$sampleid <- sample_names(ps_16905)
alpha_data <- 
  left_join(metadata, alpha, by = "sampleid") %>% 
  rename_all(tolower) 

alpha_summary = alpha_data %>% group_by(combined) %>% summarise(mean_chao = mean(chao1), mean_shannon = mean(shannon), n = n())

## plot alpha populations points

chao1 <- alpha_data %>% 
  ggplot(aes(x=redox_type, y=chao1, color = redox_type)) +
  geom_jitter(position = position_dodge(0.5)) + 
  scale_color_manual(values = c("#B2182B", "#D6604D", "#FDDBC7", "#D1E5F0", "#4393C3", "#2166AC")) +
  facet_wrap(~sample_type, nrow = 4) +
  labs(y = "ASV richness (Chao1)", x= "Redox condition") +
  theme_classic() +
  guides(color = guide_legend(nrow=2)) +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks.x = element_line(size = 0.35),
        axis.ticks.y = element_line(size = 0.35),
        axis.text.x	= element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.position = "none",
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5))

# shannon <- alpha_data %>% 
#   ggplot(aes(x=redox_type, y=shannon, color = redox_type)) +
#   geom_jitter(position = position_dodge(0.5)) +
#   scale_color_manual(values = c("#B2182B", "#D6604D", "#FDDBC7", "#D1E5F0", "#4393C3", "#2166AC")) +
#   facet_wrap(~sample_type, nrow = 4) +
#   labs(y = "Shannon diversity", x= "Redox condition") +
#   scale_y_continuous(limits = c(2, 8), 
#                      breaks = seq(2, 8, 2)) +
#   theme_classic() +
#   guides(color = guide_legend(nrow=2)) +
#   theme(axis.text = element_text(size = 7, colour = "black"),
#         axis.ticks.x = element_line(size = 0.35),
#         axis.ticks.y = element_line(size = 0.35),
#         axis.text.x	= element_text(angle = 45, hjust = 1),
#         axis.title = element_text(size = 9),
#         axis.title.x = element_text(margin = margin(t = 7)),
#         axis.title.y = element_text(margin = margin(r = 7)),
#         axis.line = element_blank(),
#         legend.text	= element_text(size = 7),
#         legend.title = element_text(size = 8),
#         legend.key.size = unit(10, "pt"),
#         strip.text = element_text(size = 8),
#         strip.background = element_blank(),
#         panel.spacing = unit(10, "pt"),
#         panel.border = element_rect(colour = "black", 
#                                     fill = NA, 
#                                     size = 0.5)) 
# 
# library(cowplot)
# prow = plot_grid(chao1 + theme(legend.position = "none"), 
#                  shannon + theme(legend.position = "none"),
#                  align = "vh",
#                  labels = c("A", "B"),
#                  hjust = -1, 
#                  ncol = 2)
# 
# prow
# 
# ggsave(plot =prow, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_alpha_points.pdf", width = 4, height = 6)

ggsave(plot = chao1, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_alpha_points.pdf", width = 4, height = 6)


## plot alpha populations bars

chao1.1 <- alpha_data %>% 
  ggplot(aes(x=redox_type, y=chao1)) +
  stat_summary(fun = mean, geom = "bar", mapping = aes(fill = sample_type)) +
  geom_point(mapping = aes(shape = redox_type)) +
  scale_fill_manual(values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
  scale_shape_manual(values = c(17,0,1,4,5,6)) +
  facet_wrap(~sample_type, nrow = 4) +
  labs(y = "ASV richness (Chao1)", x= "Redox condition") +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks.x = element_line(size = 0.35),
        axis.ticks.y = element_line(size = 0.35),
        axis.text.x	= element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.position = "none",
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5))

ggsave(plot = chao1.1, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_4_3.pdf", width = 2.5, height = 5)
  
# shannon.1 <- alpha_data %>% 
#   ggplot(aes(x=redox_type, y=shannon, fill = redox_type)) +
#   stat_summary(fun = mean, geom = "bar") +
#   scale_fill_manual(values = c("#B2182B", "#D6604D", "#FDDBC7", "#D1E5F0", "#4393C3", "#2166AC")) +
#   geom_jitter(position = position_dodge(0.5), pch = 21) + 
#   facet_wrap(~sample_type, nrow = 4) +
#   labs(y = "Shannon diversity", x= "Redox condition") +
#   scale_y_continuous(limits = c(0, 8), 
#                      breaks = seq(0, 8, 2)) +
#   theme_classic() +
#   guides(color = guide_legend(nrow=2)) +
#   theme(axis.text = element_text(size = 7, colour = "black"),
#         axis.ticks.x = element_line(size = 0.35),
#         axis.ticks.y = element_line(size = 0.35),
#         axis.text.x	= element_text(angle = 45, hjust = 1),
#         axis.title = element_text(size = 9),
#         axis.title.x = element_text(margin = margin(t = 7)),
#         axis.title.y = element_text(margin = margin(r = 7)),
#         axis.line = element_blank(),
#         legend.text	= element_text(size = 7),
#         legend.title = element_text(size = 8),
#         legend.key.size = unit(10, "pt"),
#         strip.text = element_text(size = 8),
#         strip.background = element_blank(),
#         panel.spacing = unit(10, "pt"),
#         panel.border = element_rect(colour = "black", 
#                                     fill = NA, 
#                                     size = 0.5))
# 
# library(cowplot)
# prow.1 = plot_grid(chao1.1 + theme(legend.position = "none"), 
#                  shannon.1 + theme(legend.position = "none"),
#                  align = "vh",
#                  labels = c("A", "B"),
#                  hjust = -1, 
#                  ncol = 2)
# 
# prow.1
# 
# ggsave(plot = prow.1, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_alpha.pdf", width = 4, height = 6)

```
**Fig y** Alpha diversity. Bars represent mean values of technical extraction duplicates (dots). Estimates are based on rarefied data at 16905 reads per sample, which captured nearly full diversity (see rarefaction plot)<br>

### Beta diversity

Abundance-based metrics are ignored due to potential large influence of PCR bias. Principal coordinates analysis (PCoA) of Jaccard and unweighted UniFrac distances are presented only, relying on taxon occurrences only. 

```{r total beta diversity, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.width=5, fig.height=4}

### Beta diversity analysis first
# input data  = psdata_RBRA

# input is relative abundance table
# relative abundance data
psdata_RBRA_rel <- transform_sample_counts(psdata_RBRA, fun = function(x) x/sum(x))

# transform clr of relative abundances
#psdata_RBRA_clr = transform(psdata_RBRA, transform = "clr")


# ordination
#PCoA_BC <- ordinate(psdata_RBRA_rel, method = "PCoA", distance = "bray")
PCoA_Jac <- ordinate(psdata_RBRA_rel, method = "PCoA", distance = "jaccard")
PCoA_uu <- ordinate(psdata_RBRA_rel, method = "PCoA", distance = "uunifrac")
#PCoA_wu <- ordinate(psdata_RBRA_rel, method = "PCoA", distance = "wunifrac")

colnames(sample_data(psdata_RBRA_rel))

## Abundance-based metrics are ignored due to potential large influence of PCR bias.

## Bray_curtis
# plot_PCoA_BC <- plot_ordination(physeq = psdata_RBRA_rel, 
#                                  ordination = PCoA_BC, 
#                                  type = "samples", 
#                                  axes = c(1,2), 
#                                  color = "redox_type", 
#                                  shape = "sample_type") +
#   scale_color_manual(name = "Microbial culture",
#                      values = c("#B2182B", "#F4A582", "#92C5DE", "#4393C3", "#053061")) +
#   scale_shape_manual(name = "Redox condition",
#                      values = c(3,15,16,17,18,4)) +
#   geom_point(size = 2) +
#   ggtitle("Bray-Curtis dissimilarity") +
#   theme_classic()

# phylum level
# psdata_RBRA_phylum <- tax_glom(psdata_RBRA, "Phylum")
# psdata_RBRA_phylum_rel <- transform_sample_counts(psdata_RBRA_phylum, fun = function(x) x/sum(x))
# PCoA_Jac_phylum <- ordinate(psdata_RBRA_phylum_rel, method = "PCoA", distance = "jaccard")
# plot_PCoA_Jac_phylum <- plot_ordination(physeq = psdata_RBRA_phylum_rel, 
#                                  ordination = PCoA_Jac_phylum, 
#                   type = "biplot", 
#                   axes = c(1,2), 
#                   color = "Phylum",
#                   shape = "sample_type") +
#   # scale_color_manual(name = NULL,
#   #                    values = c(brewer.pal(6, "Dark2"),brewer.pal(8,"Paired"))) +
#   ggtitle("Jaccard distance") +
#   theme_classic()


plot_PCoA_Jac <- plot_ordination(physeq = psdata_RBRA_rel, 
                                 ordination = PCoA_Jac, 
                                 type = "samples", 
                                 axes = c(1,2), 
                                 shape = "redox_type",
                                 color = "sample_type") +
  scale_color_manual(name = "Microbial culture",
                     values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
  scale_shape_manual(name = "Redox condition",
                       values = c(17,0,1,4,5,6)) +
  geom_point(size = 2) +
  ggtitle("Jaccard distance") +
  theme_classic() +
  theme(plot.title = element_text(size = 10),
        axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5))

plot_PCoA_uu <- plot_ordination(physeq = psdata_RBRA_rel, 
                                ordination = PCoA_uu, 
                                type = "samples", 
                                axes = c(1,2), 
                                shape = "redox_type",
                                color = "sample_type") + 
  scale_color_manual(name = "Microbial culture",
                     values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
  scale_shape_manual(name = "Redox condition",
                       values = c(17,0,1,4,5,6)) +
  geom_point(size = 2) +
  ggtitle("unweighted UniFrac") +
  theme_classic() +
  theme(plot.title = element_text(size = 10),
        axis.text = element_text(size = 7, colour = "black"),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5))

# plot_PCoA_wu <- plot_ordination(physeq = psdata_CBUE_rel, 
#                                 ordination = PCoA_wu, 
#                                 type = "samples", 
#                                 axes = c(1,3), 
#                                 color = "biomass_type", 
#                                 shape = "phase") + 
#   scale_color_manual(name = "Microbial culture",
#                      values = c("#B2182B", "#F4A582", "#92C5DE", "#4393C3", "#053061")) +
#   scale_shape_manual(name = "Redox condition",
#                      values = c(3,15,16,17,18,4)) +
#   ggtitle("weighted UniFrac") +
#   theme_classic() +
#   theme(axis.text = element_text(size = 7, colour = "black"),
#         axis.ticks = element_line(size = 0.25),
#         axis.title = element_text(size = 9),
#         axis.title.x = element_text(margin = margin(t = 7)),
#         axis.title.y = element_text(margin = margin(r = 7)),
#         axis.line = element_blank(),
#         legend.text	= element_text(size = 7),
#         legend.title = element_text(size = 8),
#         legend.key.width = unit(12, "pt"),
#         legend.key.height = unit(10, "pt"),
#         panel.border = element_rect(colour = "black", 
#                                     fill = NA, 
#                                     size = 0.5))
# 
prow.2 = plot_grid(plot_PCoA_Jac + theme(legend.position = "none"),
                   plot_PCoA_uu + theme(legend.position = "none"),
                   labels  = c("A", "B"),
                   ncol = 2,
                   nrow = 1,
                   align = "hv")

legend_beta <- get_legend(plot_PCoA_Jac)

beta_plot <- plot_grid(prow.2, legend_beta, ncol=2, rel_widths = c(5, 1))

ggsave(plot = beta_plot, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_4_1.pdf", width = 8, height = 4)

```
**Fig. z**. Microbial community composition based on taxon occurrences. Principal coordinates analysis (PCoA) ordination plots of community composition based on A) Jaccard distance and B) unweighted UniFrac distances. Redox conditions applied and initial origin (sample type) both explain variation in microbial community composition. Aerobic conditions, soil-derived and industrial activated sludge-derived microbial commmunities clustered most consitently. PERMANOVA statistics yet to be performed.<br>

#### PERMANOVA
```{r total beta diversity, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.width=5, fig.height=4}
# subtract sample metadata from phyloseq object (here psdata_RBRA)
metadata2 <- data.frame(sample_data(psdata_RBRA_rel), stringsAsFactors = T)

# calculate distance matrices
dist_jac = vegdist(t(otu_table(psdata_RBRA_rel)), method = "jaccard", binary = T)

dist_uu = phyloseq::UniFrac(psdata_RBRA_rel, weighted = F)

# test model assumptions
betadisper_jac_rt <- betadisper(dist_jac,metadata2$redox_type)
anova(betadisper_jac_rt) #p=0.8609 > 0.05 -> no significant difference

betadisper_jac_st <- betadisper(dist_jac,metadata2$sample_type)
anova(betadisper_jac_st) #p=0.004954 < 0.05 -> significant difference

betadisper_uu_rt <- betadisper(dist_uu,metadata2$redox_type)
anova(betadisper_uu_rt) #p=0.6903 > 0.05 -> no significant difference

betadisper_uu_st <- betadisper(dist_uu,metadata2$sample_type)
anova(betadisper_uu_st) #p=0.007284 < 0.05 -> significant difference


# PERMANOVA (permutational multivariate analysis of variance) with the 'adonis' function

adonis_jac_rt <- adonis(dist_jac ~ redox_type, permutations = 999, data = metadata2)
adonis_jac_rt 
adonis_jac_rt$aov.tab$`Pr(>F)`[1] #p=0.001 < 0.05 -> significant difference
adonis_jac_rt$aov.tab$R2[1] #20% jaccard community composition is explained by the redox type

adonis_jac_st <- adonis(dist_jac ~ sample_type, permutations = 999, data = metadata2)
adonis_jac_st
adonis_jac_st$aov.tab$`Pr(>F)`[1] #p=0.001 < 0.5 -> significant difference
adonis_jac_st$aov.tab$R2[1] #21% jaccard community composition is explained by the sample type

adonis_jac_comb <- adonis(dist_jac ~ redox_type * sample_type, permutations = 999, data = metadata2)
adonis_jac_comb 
adonis_jac_comb$aov.tab$`Pr(>F)`[3] #p=0.001 < 0.5 -> significant difference
adonis_jac_comb$aov.tab$R2[3] #35% jaccard community composition is explained by the interaction between redox type and sample type

adonis_uu_rt <- adonis(dist_uu ~ redox_type, permutations = 999, data = metadata2)
adonis_uu_rt 
adonis_uu_rt$aov.tab$`Pr(>F)`[1] #p=0.002 < 0.5 -> significant difference
adonis_uu_rt$aov.tab$R2[1] # 23% uw unifrac community composition is explained by the redox type

adonis_uu_st <- adonis(dist_uu ~ sample_type, permutations = 999, data = metadata2)
adonis_uu_st 
adonis_uu_st$aov.tab$`Pr(>F)`[1] #p=0.001 < 0.5 -> significant difference
adonis_uu_st$aov.tab$R2[1] #26% uw unifrac community composition is explained by the sample type

adonis_uu_comb <- adonis(dist_uu ~ redox_type * sample_type, permutations = 999, data = metadata2)
adonis_uu_comb 
adonis_uu_comb$aov.tab$`Pr(>F)`[3] #p=0.009 < 0.5 -> significant difference
adonis_uu_comb$aov.tab$R2[3] #31% uw unifrac community composition is explained by the interaction between redox type and sample type
```


```{r consecutive distances, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.width=5, fig.height=4}
# reshape to long format
uu_long =
dist_uu %>%
  as.matrix() %>%
  as_tibble(rownames = "sample_a") %>%
  pivot_longer(-sample_a, names_to = "sample_b", values_to = "distance") %>%
  mutate(metric = "uu")

jaccard_long =
dist_jac %>%
  as.matrix() %>%
  as_tibble(rownames = "sample_a") %>%
  pivot_longer(-sample_a, names_to = "sample_b", values_to = "distance") %>%
  mutate(metric = "jaccard")


# define consecutive sampling moments
consecutive_redox = c("aerobic_to_nitrate", "nitrate_to_iron", "iron_to_sulphate", "sulphate_to_methanogenic")
#metadata2 %>% pull(redox_type) %>% levels()

comp_inoculum = c("inoculum_to_aerobic", "inoculum_to_nitrate", "inoculum_to_iron", "inoculum_to_sulphate", "inoculum_to_methanogenic")

## consecutive redox
# reshape distance data and combine with metadata
# all_dists =
# bind_rows(uu_long, jaccard_long) %>%
#   filter(sample_a != sample_b) %>% # remove self-comparisons
#   inner_join(., metadata2 %>% select(sampleid, redox_type, sample_type, replicate), by = c("sample_a" = "sampleid")) %>%
#   rename(redox_type_a = redox_type,
#          sample_type_a = sample_type,
#          replicate_a = replicate) %>% 
#    inner_join(., metadata2 %>% select(sampleid, redox_type, sample_type, replicate), by = c("sample_b" = "sampleid")) %>%
#   rename(redox_type_b = redox_type,
#          sample_type_b = sample_type,
#          replicate_b = replicate) %>% 
#   mutate(comp = paste0(redox_type_a, "_to_", redox_type_b)) %>%
#   filter(comp %in% consecutive_redox) %>% # select only distances between consecutive redox types
#   mutate(comp = factor(comp, levels = consecutive_redox)) %>%
#   filter(sample_type_a == sample_type_b,
#          replicate_a == replicate_b) 
#          
# 
# consec_dist_uu <- all_dists %>%
#   filter(metric == "uu") %>% 
#   ggplot(aes(x = comp, y = distance, color = sample_type_a)) +
#   geom_point(size = 3, alpha = 0.6, show.legend = T, position = position_dodge(0.05)) +
#   scale_color_manual(values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
#   scale_fill_manual(values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
#   theme_classic() +
#   theme(axis.text = element_text(size = 7, colour = "black"),
#         axis.text.x = element_text(angle = 45, hjust = 1),
#         axis.ticks = element_line(size = 0.25),
#         axis.title = element_text(size = 9),
#         axis.title.x = element_text(margin = margin(t = 7)),
#         axis.title.y = element_text(margin = margin(r = 7)),
#         axis.line = element_blank(),
#         legend.text	= element_text(size = 7),
#         legend.title = element_text(size = 8),
#         legend.key.size = unit(10, "pt"),
#         strip.text = element_text(size = 8),
#         strip.background = element_blank(),
#         panel.spacing = unit(5, "pt"),
#         panel.border = element_rect(colour = "black", 
#                                     fill = NA, 
#                                     size = 0.5),
#         legend.position = "right") +
# #  facet_wrap(~ metric) +
#   labs(y = "Distance",
#        x = NULL)
# 
# ggsave(plot = consec_dist_uu, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_distuu.pdf", width = 4, height = 4)
# 
# 
# consec_dist_jac <- all_dists %>%
#   filter(metric == "jaccard") %>% 
#   ggplot(aes(x = comp, y = distance, color = sample_type_a)) +
#   geom_point(size = 3, alpha = 0.6, show.legend = T, position = position_dodge(0.05)) +
#   scale_color_manual(values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
#   scale_fill_manual(values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
#   theme_classic() +
#   theme(axis.text = element_text(size = 7, colour = "black"),
#         axis.text.x = element_text(angle = 45, hjust = 1),
#         axis.ticks = element_line(size = 0.25),
#         axis.title = element_text(size = 9),
#         axis.title.x = element_text(margin = margin(t = 7)),
#         axis.title.y = element_text(margin = margin(r = 7)),
#         axis.line = element_blank(),
#         legend.text	= element_text(size = 7),
#         legend.title = element_text(size = 8),
#         legend.key.size = unit(10, "pt"),
#         strip.text = element_text(size = 8),
#         strip.background = element_blank(),
#         panel.spacing = unit(5, "pt"),
#         panel.border = element_rect(colour = "black", 
#                                     fill = NA, 
#                                     size = 0.5),
#         legend.position = "right") +
# #  facet_wrap(~ metric) +
#   labs(y = "Distance",
#        x = NULL)
# 
# ggsave(plot = consec_dist_jac, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_distjac.pdf", width = 4, height = 4)



## inoculum vs each redox
# reshape distance data and combine with metadata
all_dists2 =
bind_rows(uu_long, jaccard_long) %>%
  filter(sample_a != sample_b) %>% # remove self-comparisons
  inner_join(., metadata2 %>% select(sampleid, redox_type, sample_type), by = c("sample_a" = "sampleid")) %>%
  rename(redox_type_a = redox_type,
         sample_type_a = sample_type) %>% 
   inner_join(., metadata2 %>% select(sampleid, redox_type, sample_type), by = c("sample_b" = "sampleid")) %>%
  rename(redox_type_b = redox_type,
         sample_type_b = sample_type) %>% 
  mutate(comp = paste0(redox_type_a, "_to_", redox_type_b)) %>%
  filter(comp %in% comp_inoculum) %>% 
  mutate(comp = factor(comp, levels = comp_inoculum)) %>%
  filter(sample_type_a == sample_type_b)
         

comp_inoc_uu <- all_dists2 %>%
  filter(metric == "uu") %>% 
  ggplot(aes(x = comp, y = distance, color = sample_type_a)) +
  geom_point(size = 2, alpha = 0.6, position = position_dodge(0.05)) +
  ggtitle("unweighted UniFrac distances") +
  scale_color_manual(values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
  scale_fill_manual(values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
  scale_y_continuous(limits = c(0.3, 0.9), 
                     breaks = seq(0.3, 0.9, 0.2)) +
  theme_classic() +
  theme(plot.title = element_text(size = 10),
        axis.text = element_text(size = 7, colour = "black"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(5, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        legend.position = "right") +
  labs(y = "Distance",
       x = NULL)

comp_inoc_jac <- all_dists2 %>%
  filter(metric == "jaccard") %>% 
  ggplot(aes(x = comp, y = distance, color = sample_type_a)) +
  geom_point(size = 2, alpha = 0.6, position = position_dodge(0.05)) +
  ggtitle("Jaccard distances") +
  scale_color_manual(values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
  scale_fill_manual(values = c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")) +
  scale_y_continuous(limits = c(0.3, 0.9), 
                     breaks = seq(0.3, 0.9, 0.2)) +
  theme_classic() +
  theme(plot.title = element_text(size = 10),
        axis.text = element_text(size = 7, colour = "black"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.ticks = element_line(size = 0.25),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text	= element_text(size = 7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(5, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5),
        legend.position = "right") +
  labs(y = "Distance",
       x = NULL)

prow.6 = plot_grid(comp_inoc_jac + theme(legend.position = "none"),
                   comp_inoc_uu + theme(legend.position = "none"),
                   labels  = c("C", "D"),
                   ncol = 2,
                   nrow = 1,
                   align = "hv")

legend_comp <- get_legend(comp_inoc_jac)

comp_plot <- plot_grid(prow.6, legend_comp, ncol=2, rel_widths = c(5, 1))

ggsave(plot = comp_plot, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_4_2.pdf", width = 8, height = 8.6)

beta_complete <- plot_grid(beta_plot,
                           comp_plot,
                           ncol = 1,
                           nrow = 2,
                           rel_heights = c(4, 4.9),
                           align = "hv")

ggsave(plot = beta_complete, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_4.pdf", width = 5.5, height = 6)
```

### Relative abundance of Class
```{r rel abund barplot class, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

#load psmelt function
source("C:/Users/Rita/Documents/R/Article1/scripts/psmelt.r")

#input data
ps_Class <- psmelt(transform_sample_counts(tax_glom(psdata_RBRA, "Class"), fun = function(x) x/sum(x))) #'transform_sample_counts' transforms abundance data in an otu_table sample-by-sample; 'tax_glom' agglomerates taxa of the same type.

# count n genera n = 123
ps_Class %>% 
  as_tibble() %>% 
  mutate(Class = factor(Class)) %>% 
  pull(Class) %>% 
  levels()


Class_abundances <- ps_Class %>% 
  as_tibble() %>% 
  select(sampleid, redox_type, sample_type, Class, Abundance) %>% 
  mutate(redox_type = as.character(redox_type),
         sample_type = as.character(sample_type)) %>% 
  group_by(sampleid, redox_type, sample_type, Class) %>% 
  summarize(rel_abund = sum(Abundance), .groups = "drop") %>% 
  group_by(redox_type,sample_type, Class) %>% 
  summarize(mean_rel_abund = 100* mean(rel_abund), .groups = "drop") %>% 
  mutate(Class = str_replace(Class, "(.*)_unClassified", "UnClassified *\\1*"),
         Class = str_replace(Class, "^(\\S*)$", "*\\1*"))


Class_pool <- Class_abundances %>% 
  group_by(Class) %>% 
  summarize(pool = max(mean_rel_abund) < 3, 
            mean = mean(mean_rel_abund), 
            .groups = "drop") 
  
inner_join(Class_abundances, Class_pool, by="Class") %>% 
  mutate(Class = if_else(pool, "Other", Class)) %>% 
  group_by(Class) %>%
  summarize(mean_rel_abund = sum(mean_rel_abund), 
            mean = min(mean),
            .groups = "drop") %>% 
  mutate(Class = factor(Class), 
         Class = fct_reorder(Class, mean, .desc = T))

# plot vertical

plot_Class <- inner_join(Class_abundances, Class_pool, by="Class") %>% 
  mutate(Class = if_else(pool, "Other", Class)) %>% 
  group_by(redox_type, sample_type, Class) %>%
  summarize(mean_rel_abund = sum(mean_rel_abund), 
            mean = min(mean),
            .groups = "drop") %>% 
  mutate(Class = factor(Class), 
         Class = fct_reorder(Class, mean, .desc = T),
         #Class = fct_shift(Class, n=1),
         redox_type = factor(redox_type),
         redox_type = fct_relevel(redox_type, rev(c("methanogenic","sulphate", "iron", "nitrate", "aerobic", "inoculum"))),
         sample_type = factor(sample_type),
         sample_type = fct_relevel(sample_type, rev(c("ind", "ditch", "mun", "soil")))) %>% 
ggplot(aes(x=redox_type, y = mean_rel_abund, fill = Class)) +
  geom_col() +
  scale_fill_manual(name=NULL, 
                    values = c("#B2182B", "#D6604D", "#2166AC", "#4393C3", "#4D4D4D", "#878787", "#01665E", "#35978F", "#ABDDA4", "#E6F598", "#8C510A", "#BF812D", "#C51B7D", "#DE77AE", "#4D9221", "#7FBC41",  "#762A83", "#9970AB", "#FDAE61", "#FEE090",  "#1B7837", "#5AAE61")) +
  facet_wrap(~sample_type, ncol = 4) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x="Redox condition", y="Mean Relative Abundance (%)") +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks.x = element_line(size = 0.35),
        axis.ticks.y = element_line(size = 0.35),
        axis.text.x	= element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text = element_markdown(size=7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5))

 
prow.3 = plot_grid(plot_Class + theme(legend.position = "none"), 
                   ncol = 1, 
                   nrow = 1, 
                   align = "hv")

legend_bar <- get_legend(plot_Class + guides(fill = guide_legend(ncol = 1)) +
    theme(legend.position = "right"))
bar_plot <- plot_grid(prow.3, legend_bar, ncol=3, rel_widths = c(2, 0.5, 0))

ggsave(plot = bar_plot, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_vert.pdf", width = 8, height = 4)


# Plot vertical only inoculum

plot_Class.2 <- inner_join(Class_abundances, Class_pool, by="Class") %>% 
  mutate(Class = if_else(pool, "Other", Class)) %>% 
  group_by(redox_type, sample_type, Class) %>%
  summarize(mean_rel_abund = sum(mean_rel_abund), 
            mean = min(mean),
            .groups = "drop") %>% 
  mutate(Class = factor(Class), 
         Class = fct_reorder(Class, mean, .desc = T),
         #Class = fct_shift(Class, n=1),
         redox_type = factor(redox_type),
         redox_type = fct_relevel(redox_type, rev(c("methanogenic","sulphate", "iron", "nitrate", "aerobic", "inoculum"))),
         sample_type = factor(sample_type),
         sample_type = fct_relevel(sample_type, rev(c("ind", "ditch", "mun", "soil")))) %>% 
  filter(redox_type == "inoculum") %>% 
ggplot(aes(x=redox_type, y = mean_rel_abund, fill = Class)) +
  geom_col() +
  scale_fill_manual(name=NULL, 
                    values = c("#B2182B", "#D6604D", "#2166AC", "#4393C3", "#4D4D4D", "#878787", "#01665E", "#35978F", "#ABDDA4", "#E6F598", "#8C510A", "#BF812D", "#C51B7D", "#DE77AE", "#4D9221", "#7FBC41",  "#762A83", "#9970AB", "#FDAE61", "#FEE090",  "#1B7837", "#5AAE61")) +
  facet_wrap(~sample_type, ncol = 4) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0), position = "top") +
  labs(x="Microbial culture", y="Mean Relative Abundance (%)") +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_line(size = 0.35),
        axis.text.x	= element_blank(),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(r = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text = element_markdown(size=7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5))

 
prow.4 = plot_grid(plot_Class.2 + theme(legend.position = "none"), 
                   ncol = 1, 
                   nrow = 1, 
                   align = "hv")

legend_bar <- get_legend(plot_Class.2 + guides(fill = guide_legend(ncol = 1)) +
    theme(legend.position = "right"))
bar_plot.2 <- plot_grid(prow.4, legend_bar, ncol=3, rel_widths = c(1, 0.5, 0))

ggsave(plot = bar_plot.2, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_vinoc.pdf", width = 4, height = 4)


# Plot horizontal

plot_Class.3 <- inner_join(Class_abundances, Class_pool, by="Class") %>% 
  mutate(Class = if_else(pool, "Other", Class)) %>% 
  group_by(redox_type, sample_type, Class) %>%
  summarize(mean_rel_abund = sum(mean_rel_abund), 
            mean = min(mean),
            .groups = "drop") %>% 
  mutate(Class = factor(Class), 
         Class = fct_reorder(Class, mean, .desc = T),
         #Class = fct_shift(Class, n=1),
         redox_type = factor(redox_type),
         redox_type = fct_relevel(redox_type, rev(c("inoculum","aerobic", "nitrate", "iron", "sulphate", "methanogenic"))),
         sample_type = factor(sample_type),
         sample_type = fct_relevel(sample_type, rev(c("ind", "ditch", "mun", "soil")))) %>% 
ggplot(aes(x=redox_type, y = mean_rel_abund, fill = Class)) +
  geom_col() +
  scale_fill_manual(name=NULL, 
                    values = c("#B2182B", "#D6604D", "#2166AC", "#4393C3", "#4D4D4D", "#878787", "#01665E", "#35978F", "#ABDDA4", "#E6F598", "#8C510A", "#BF812D", "#C51B7D", "#DE77AE", "#4D9221", "#7FBC41",  "#762A83", "#9970AB", "#FDAE61", "#FEE090",  "#1B7837", "#5AAE61")) +
  facet_wrap(~sample_type, ncol = 4) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x="Redox condition", y="Mean Relative Abundance (%)") +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks.x = element_line(size = 0.35),
        axis.ticks.y = element_line(size = 0.35),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text = element_markdown(size=7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5)) +
  coord_flip()

 
prow.5 = plot_grid(plot_Class.3 + theme(legend.position = "none"), 
                   ncol = 1, 
                   nrow = 1, 
                   align = "hv")

legend_bar <- get_legend(plot_Class.3 + guides(fill = guide_legend(ncol = 8)) +
    theme(legend.position = "right"))
bar_plot.3 <- plot_grid(prow.5, legend_bar, nrow=2, rel_heights = c(5, 1))

ggsave(plot = bar_plot.3, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_S4.pdf", width = 8, height = 4)

# Plot horizontal only inoculum

plot_Class.4 <- inner_join(Class_abundances, Class_pool, by="Class") %>% 
  mutate(Class = if_else(pool, "Other", Class)) %>% 
  group_by(redox_type, sample_type, Class) %>%
  summarize(mean_rel_abund = sum(mean_rel_abund), 
            mean = min(mean),
            .groups = "drop") %>% 
  mutate(Class = factor(Class), 
         Class = fct_reorder(Class, mean, .desc = T),
         #Class = fct_shift(Class, n=1),
         redox_type = factor(redox_type),
         redox_type = fct_relevel(redox_type, rev(c("methanogenic","sulphate", "iron", "nitrate", "aerobic", "inoculum"))),
         sample_type = factor(sample_type),
         sample_type = fct_relevel(sample_type, rev(c("ind", "ditch", "mun", "soil")))) %>% 
  filter(redox_type == "inoculum") %>% 
ggplot(aes(x=redox_type, y = mean_rel_abund, fill = Class)) +
  geom_col() +
  scale_fill_manual(name=NULL, 
                    values = c("#B2182B", "#D6604D", "#2166AC", "#4393C3", "#4D4D4D", "#878787", "#01665E", "#35978F", "#ABDDA4", "#E6F598", "#8C510A", "#BF812D", "#C51B7D", "#DE77AE", "#4D9221", "#7FBC41",  "#762A83", "#9970AB", "#FDAE61", "#FEE090",  "#1B7837", "#5AAE61")) +
  facet_nested(sample_type~redox_type, switch = "y") +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  labs(x="Microbial culture", y="Mean Relative Abundance (%)") +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks.x = element_line(size = 0.35),
        axis.ticks.y = element_blank(),
        axis.text.y	= element_blank(),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text = element_markdown(size=7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        strip.text.x = element_blank(),
        strip.text.y = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5)) +
  coord_flip()

 
prow.5 = plot_grid(plot_Class.4 + theme(legend.position = "none"), 
                   ncol = 1, 
                   nrow = 1, 
                   align = "hv")

legend_bar <- get_legend(plot_Class.4 + guides(fill = guide_legend(ncol = 2)) +
    theme(legend.position = "right"))
bar_plot.4 <- plot_grid(prow.5, legend_bar, ncol=3, rel_widths = c(1, 0.5, 0))

ggsave(plot = bar_plot.4, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_hinoc.pdf", width = 7, height = 2.5)

```
```{r rel abund barplot genus, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

#input data
ps_Genus <- psmelt(transform_sample_counts(tax_glom(psdata_RBRA, "Genus"), fun = function(x) x/sum(x))) #'transform_sample_counts' transforms abundance data in an otu_table sample-by-sample; 'tax_glom' agglomerates taxa of the same type.

# count n genera n = 123
ps_Genus %>% 
  as_tibble() %>% 
  mutate(Genus = factor(Genus)) %>% 
  pull(Genus) %>% 
  levels()


Genus_abundances <- ps_Genus %>% 
  as_tibble() %>% 
  select(sampleid, redox_type, sample_type, Genus, Abundance) %>% 
  mutate(redox_type = as.character(redox_type),
         sample_type = as.character(sample_type)) %>% 
  group_by(sampleid, redox_type, sample_type, Genus) %>% 
  summarize(rel_abund = sum(Abundance), .groups = "drop") %>% 
  group_by(redox_type,sample_type, Genus) %>% 
  summarize(mean_rel_abund = 100* mean(rel_abund), .groups = "drop") %>% 
  mutate(Genus = str_replace(Genus, "(.*)_unclassified", "Unclassified *\\1*"),
         Genus = str_replace(Genus, "^(\\S*)$", "*\\1*"))


Genus_pool <- Genus_abundances %>% 
  group_by(Genus) %>% 
  summarize(pool = max(mean_rel_abund) < 8, 
            mean = mean(mean_rel_abund), 
            .groups = "drop") 
  
inner_join(Genus_abundances, Genus_pool, by="Genus") %>% 
  mutate(Genus = if_else(pool, "Other", Genus)) %>% 
  group_by(Genus) %>%
  summarize(mean_rel_abund = sum(mean_rel_abund), 
            mean = min(mean),
            .groups = "drop") %>% 
  mutate(Genus = factor(Genus), 
         Genus = fct_reorder(Genus, mean, .desc = T))

plot_Genus <- inner_join(Genus_abundances, Genus_pool, by="Genus") %>% 
  mutate(Genus = if_else(pool, "Other", Genus)) %>% 
  group_by(redox_type, sample_type, Genus) %>%
  summarize(mean_rel_abund = sum(mean_rel_abund), 
            mean = min(mean),
            .groups = "drop") %>% 
  mutate(Genus = factor(Genus), 
         Genus = fct_reorder(Genus, mean, .desc = T),
         #Genus = fct_shift(Genus, n=1),
         redox_type = factor(redox_type),
         redox_type = fct_relevel(redox_type, rev(c("methanogenic","sulphate", "iron", "nitrate", "aerobic", "inoculum"))),
         sample_type = factor(sample_type),
         sample_type = fct_relevel(sample_type, rev(c("ind", "ditch", "mun", "soil")))) %>% 
ggplot(aes(x=redox_type, y = mean_rel_abund, fill = forcats::fct_rev(Genus))) +
  geom_col() +
  scale_fill_manual(name=NULL, 
                    values = c("white", "#5AAE61", "#1B7837", "#FEE090", "#FDAE61", "#9970AB", "#762A83", "#7FBC41", "#4D9221", "#DE77AE", "#C51B7D", "#BF812D", "#8C510A", "#E6F598", "#ABDDA4", "#35978F", "#01665E", "#878787", "#4D4D4D", "#4393C3", "#2166AC", "#D6604D", "#B2182B")) +
  facet_wrap(~sample_type, ncol = 4) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x="Redox condition", y="Mean Relative Abundance (%)") +
  theme_classic() +
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.ticks.x = element_line(size = 0.35),
        axis.ticks.y = element_line(size = 0.35),
        axis.text.x	= element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 9),
        axis.title.x = element_text(margin = margin(t = 7)),
        axis.title.y = element_text(margin = margin(r = 7)),
        axis.line = element_blank(),
        legend.text = element_markdown(size=7),
        legend.title = element_text(size = 8),
        legend.key.size = unit(10, "pt"),
        strip.text = element_text(size = 8),
        strip.background = element_blank(),
        panel.spacing = unit(10, "pt"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    size = 0.5))

 
prow.7 = plot_grid(plot_Genus + theme(legend.position = "none"), 
                   ncol = 1, 
                   nrow = 1, 
                   align = "hv")

legend_bar <- get_legend(plot_Genus + guides(fill = guide_legend(ncol = 1)) +
    theme(legend.position = "right"))

bar_plot.5 <- plot_grid(prow.7, legend_bar, ncol=3, rel_widths = c(2, 0.5, 0))

bar_plot.5

ggsave(plot = bar_plot.5, "C:/Users/Rita/Documents/R/Article1/figures/Figure1_S5.pdf", width = 8, height = 4)
```
### Capscale analysis
```{r capscale analysis, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
### db-RDA using chemical data

library(tidyverse)
library(ggord)
library(ggtext)
library(glue)
library(lubridate)
library(phia)
library(kableExtra)
library(MASS)

## r db_RDA chemical data

## This analysis uses a phyloseq object sent by Rita on 20220816 and chemical data that should be joined first

# load phyloseq object
phy_rita = psdata_RBRA

# chemical data
chem_data = readxl::read_xlsx("C:/Users/Rita/Documents/R/Article1/input_data/Article1_chemical_data.xlsx")

# sample_data
sam_dat = 
  sample_data(phy_rita) %>% data.frame() %>% dplyr::select(SampleID = sampleid, everything()) %>% tibble

# joined data
chem_data_added = sam_dat %>% inner_join(., chem_data, by = "SampleID")

# NOTE inocula are filtered out because they do not have data on micropollutant removal:
is_innoculum = setdiff(sam_dat$SampleID, chem_data$SampleID)
subset(sam_dat, SampleID %in% is_innoculum)


# overwriting old metadata
phy_rita_redox = subset_samples(phy_rita, !sample_names(phy_rita) %in% is_innoculum)
phy_rita_redox = prune_taxa(taxa_sums(phy_rita_redox)>0, phy_rita_redox)

sam_data = sample_data(chem_data_added)
sample_names(sam_data) = chem_data_added$SampleID
sample_data(phy_rita_redox) = sam_data




### r capscale with partialling out sampletype

# rarefy
min_ss = min(sample_sums(phy_rita_redox))

# rarefy data
set.seed(711)
phy_rita_redox_16095 = rarefy_even_depth(phy_rita_redox, sample.size = min_ss, rngseed = 711, trimOTUs = T)

# total number of reads
tot_read = phy_rita_redox_16095 %>% sample_sums(.) %>% sum()

# create taxa acronyms
df_taxa_names = data.frame(OTU = taxa_names(phy_rita_redox_16095),
                           ASV = paste0("ASV_",seq(1:ntaxa(phy_rita_redox_16095))))

# rename colnames with acronyms
abund = t(otu_table(phy_rita_redox_16095))
cap_data = abund/rowSums(abund)
colnames(cap_data) = df_taxa_names$ASV

rownames(cap_data)
rownames(chem_data_added) = chem_data_added$SampleID

# predictors
chem_pred = 
  chem_data_added %>% 
  dplyr::select(Sample_type, Redox_type, GAB:MET) %>% 
  mutate(MET_ESA = as.numeric(MET_ESA),
         MET_OA = as.numeric(MET_OA)) %>% 
  mutate(across(where(is.numeric), ~if_else(.<0, 0, .))) %>% 
  mutate(across(where(is.numeric), ~scale(.)),
         Redox_type = factor(Redox_type, levels = c("aerobic", "nitrate", "iron", "sulphate", "methanogenic")))



# GGally::ggpairs(chem_pred, columns = 2:ncol(chem_pred), 
#                 aes(colour=Sample_type), progress = F)



# model definitions (all predictor removal efficiencies are added)

# full.model <- capscale(cap_data ~
#                          ACK + CBZ +
#                          MCPP + `24_D` + ANP +
#                           BTZ + `1H_BTR`+ CLZ_DP + CLZ_MDP +
#                          CLZ + MET_ESA +
#                          MET_OA + MET,
#                        chem_pred[,-c(1:2)],
#                        dist="jaccard",
#                        na.action = na.exclude)

redox.model <- capscale(cap_data ~ 
                         ACK + CBZ + 
                          MCPP + `24_D` + ANP +
                          BTZ + `1H_BTR`+ CLZ_DP + CLZ_MDP +
                          CLZ + MET_ESA +
                          MET_OA + MET +
                          Condition(Sample_type), # partial analysis now
                        chem_pred[,-2], 
                        dist="jaccard",
                        na.action = na.exclude)

vif.cca(redox.model)

# sample_type.model <- capscale(cap_data[-23,] ~ 
#                   GAB + ACK + CBZ + 
#                   MCPP + `24_D` + ANP +
#                   BAM + BTZ + `1H_BTR`+ CLZ_DP + CLZ_MDP +
#                   CLZ + DCB + MET_ESA +
#                   MET_OA + MET +
#                   Condition(Redox_type), # partial analysis now
#                 chem_pred[,-1], 
#                 dist="jaccard",
#                 na.action = na.exclude)

# model selection

# selectedMod_full <- step(full.model)
# selectedMod_st <- step(sample_type.model)
selectedMod_red <- step(redox.model)

smry = summary(redox.model)

# anova tables with fdr-corrected q values
# anova_tab_full = anova(selectedMod_full, by = "terms") %>% as_tibble(rownames = "terms")
# anova_tab_full %>% 
#   mutate(R2 = 100*(SumOfSqs/sum(SumOfSqs))) %>% 
#   mutate(fdr_q = p.adjust(`Pr(>F)`, "fdr")) %>% # correct p values for multiple testingfilter(fdr_q < 0.1)
#   filter(fdr_q < 0.1 | is.na(fdr_q))
# 
# anova_tab_st = anova(selectedMod_st, by = "terms") %>% as_tibble(rownames = "terms")
# anova_tab_st %>% 
#   mutate(R2 = 100*(SumOfSqs/sum(SumOfSqs))) %>% 
#   mutate(fdr_q = p.adjust(`Pr(>F)`, "fdr")) %>% # correct p values for multiple testingfilter(fdr_q < 0.1)
#   filter(fdr_q < 0.1 | is.na(fdr_q))

#general ANOVA
anova_tab_gen = anova(selectedMod_red) %>% as_tibble(rownames = "terms")

#redox ANOVA
anova_tab_red = anova(selectedMod_red, by = "terms") %>% as_tibble(rownames = "terms")
anova_tab_red = anova_tab_red %>% 
  mutate(R2 = 100*(SumOfSqs/sum(SumOfSqs))) %>% 
  mutate(fdr_q = p.adjust(`Pr(>F)`, "fdr")) %>% # correct p values for multiple testingfilter(fdr_q < 0.1)
  filter(fdr_q < 0.1 | is.na(fdr_q))

print(anova_tab_red)


# plot dbRDA model focussed on redox_conditions (i.e. + Condition(Sample_type))

plot_data = chem_data_added %>% dplyr::select(SampleID, Sample_type,Redox_type, any_of(smry$biplot %>% rownames()))
df1  <- data.frame(smry$sites[,1:2]) %>% as_tibble(rownames = "SampleID")   # CAP1 and CAP2
plot_data = df1 %>% inner_join(., plot_data, by = "SampleID" )


# plot CAP ordinations
# axis 1 vs 2
ord_red_ax12 = 
  ggord(redox.model,
        xlims = c(-1.1, 0.5),
        ylims = c(-0.8, 0.6),
        arrow = 0.2,
        axes = c("1","2"),
        grp_in = plot_data$Redox_type,
        ellipse =F, 
        coord_fix = T,
        # ptslab = T, 
        # size = NA,
        addsize = 0,
        add_col = NULL,
        ext = 1.2,
        vec_ext = 0.8,
        var_sub = anova_tab_red$terms[-length(anova_tab_red$terms)]) +
  labs(title = "Partial dbRDA - effect of Redox condition; CAP1 vs CAP2")

# axis 1 vs 3
ord_red_ax13 = 
  ggord(redox.model,
        xlims = c(-1.1, 0.5),
        ylims = c(-0.9, 0.6),
        arrow = 0.2,
        axes = c("1","3"),
        grp_in = plot_data$Redox_type,
        ellipse =F, 
        coord_fix = T,
        # ptslab = T, 
        # size = NA,
        addsize = 0,
        ext = 1.2,
        vec_ext = 0.8,
        var_sub = anova_tab_red$terms[-length(anova_tab_red$terms)]) +
  labs(title = "Partial dbRDA - effect of Redox condition; CAP1 vs CAP3")


# make ggord, remove points layer and add shapes etc
ord_red_ax12$layers[[1]] <- NULL # to adjust shape as well
ord_red_ax13$layers[[1]] <- NULL # to adjust shape as well

ord_red_ax12$data <- ord_red_ax12$data %>% 
  mutate(newgrp = plot_data$Sample_type, # add extra group for sample_type
         samplecheck = plot_data$SampleID,
         Groups = factor(Groups, levels = c("aerobic", "nitrate", "iron", "sulphate", "methanogenic")),
         newgrp = factor(newgrp, levels = c("soil", "mun", "ditch", "ind")))

ord_red_ax13$data <- ord_red_ax13$data %>% 
  mutate(newgrp = plot_data$Sample_type, # add extra group for sample_type
         samplecheck = plot_data$SampleID,
         Groups = factor(Groups, levels = c("aerobic", "nitrate", "iron", "sulphate", "methanogenic")),
         newgrp = factor(newgrp, levels = c("soil", "mun", "ditch", "ind")))

# shape vals
shapes_red = c(22, 21, 4, 24, 25)
colors_red = c("#C92127", "#F3A484", "#93C4DD", "#0772B2")

# plot ordinations again
plot_ord_red_ax12 = 
  ord_red_ax12 + geom_point(aes(shape = Groups, colour = newgrp, group = newgrp), size=2, stroke=1.5, alpha=1) + 
  scale_shape_manual(name = "",
                     values = shapes_red) +
  scale_color_manual(name = "",
                     values = colors_red,
                     labels = c("Soil","Mun AS","Ditch", "Ind AS")) + 
  guides(fill = guide_legend(override.aes= list(shape = NA))) + 
  theme(legend.title = element_blank())

plot_ord_red_ax13 = 
  ord_red_ax13 + geom_point(aes(shape = Groups, colour = newgrp, group = newgrp), size=2, stroke=1.5, alpha=1) + 
  scale_shape_manual(name = "",
                     values = shapes_red) +
  scale_color_manual(name = "",
                     values = colors_red,
                     labels = c("Soil","Mun AS","Ditch", "Ind AS")) + 
  guides(fill = guide_legend(override.aes= list(shape = NA))) + 
  theme(legend.title = element_blank())

# plot separately and legend
plot_ord_red_ax12 + theme(text = element_text(size = unit(8, "pt")),
                          plot.margin=margin(t=1, b=1, unit="cm"),
                          legend.position = "bottom") + guides(color=guide_legend(nrow=4,byrow=TRUE),
                                                               shape=guide_legend(nrow=5,byrow=TRUE))
plot_ord_red_ax13 + theme(text = element_text(size = unit(8, "pt")),
                          plot.margin=margin(t=1, b=1, unit="cm"))

legend_bar_CAP = 
  get_legend(plot_ord_red_ax12 + theme( legend.position = "bottom",
                                        legend.box = "vertical",
                                        legend.margin=margin(),
                                        legend.key.size = unit(1, 'cm'), #change legend key size
                                        legend.key.height = unit(1, 'cm'), #change legend key height
                                        legend.key.width = unit(1, 'cm'), #change legend key width
                                        legend.title = element_text(size=0), #change legend title font size
                                        legend.text = element_text(size=12)))

# combine plots
CAP_plot = 
  plot_grid(
    plot_ord_red_ax12 + theme(legend.position = "none"), 
    plot_ord_red_ax13 + theme(legend.position = "none"), 
    labels  = c("A", "B"), 
    ncol = 2, 
    nrow = 1, 
    align = "hv")


CAP_AB_plot <- plot_grid(CAP_plot, legend_bar_CAP, ncol=1, nrow = 2, rel_heights = c(5, 1))

# save plot
ggsave(CAP_AB_plot, filename = "C:/Users/Rita/Documents/R/Article1/figures/RBRA_proj2_CAPscale_Redox_Cond-SampleType.pdf", width = 12, height = 5)


# format anova table
anova_tab_red %>% 
  kableExtra::kbl(digits = 3, 
                  caption = "Constrained ordination using db-RDA (Jaccard distances)<br> Associations between microbial community membership and MP removal efficiencies<br>Terms = MPs with FDR q<0.1 (stepwise selection)") %>% 
  kableExtra::kable_classic()

```